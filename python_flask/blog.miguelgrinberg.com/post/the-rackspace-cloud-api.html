<!DOCTYPE html>
<html>
  
<!-- Mirrored from blog.miguelgrinberg.com/post/the-rackspace-cloud-api by HTTrack Website Copier/3.x [XR&CO'2014], Fri, 14 Aug 2015 06:43:47 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head>
    
    <title>
    
        The Rackspace Cloud API - miguelgrinberg.com
    
</title>
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
	<meta name="description" content="miguelgrinberg.com">
	<meta name="copyright" content="Copyright (c) 2012-2015 Miguel Grinberg">
	<meta name="author" content="Miguel Grinberg">
    
    <meta name="keywords" content="rackspace, cloud, openstack, nova">
    

    
    <!-- Bootstrap -->
    <link href="../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.0/css/bootstrap.min.css" rel="stylesheet" media="screen">
    <link href="../static/prettify.css" type="text/css" rel="stylesheet" />
    <link href="../static/colorbox/colorbox.css" rel="stylesheet" type="text/css" />
    <link href="../static/style.css" rel="stylesheet" type="text/css" />

    <link rel="shortcut icon" href="../static/favicon.ico">
	<link rel="alternate" type="application/rss+xml" href="../feed" title="miguelgrinberg.com RSS feed">

  </head>
  <body>
    
    <!-- facebook sdk -->
    <div id="fb-root"></div>
    <script>(function(d, s, id) {
      var js, fjs = d.getElementsByTagName(s)[0];
      if (d.getElementById(id)) return;
      js = d.createElement(s); js.id = id;
      js.src = "../../connect.facebook.net/en_US/all.js#xfbml=1";
      fjs.parentNode.insertBefore(js, fjs);
    }(document, 'script', 'facebook-jssdk'));</script>
    <!-- google plus sdk -->
    <script type="text/javascript" src="../../apis.google.com/js/plusone.js"></script>
    <!-- twitter sdk -->
    <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="../../platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>
    <!-- linkedin sdk -->
    <script src="../../platform.linkedin.com/in.js" type="text/javascript"></script>

    
    <nav class="navbar navbar-default" role="navigation">
        <div class="container-fluid">
            <div class="container">
                <div class="navbar-header">
                    <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                        <span class="sr-only">Toggle navigation</span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </button>
                    <a class="navbar-brand" href="http://blog.miguelgrinberg.com/index">miguelgrinberg.com</a>
                </div>
                <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
                    <ul class="nav navbar-nav">
                        <li><a href="http://blog.miguelgrinberg.com/index">Home</a></li>
                        <li><a href="about-me.html">About Me</a></li>
                        <li><a href="about-this-blog.html">About This Blog</a></li>
                        
                    </ul>
                    <ul class="nav navbar-nav navbar-right">
                        <li>
                            <p class="navbar-text" style="margin-top: 10px; margin-bottom: 0px;">
                                <a type="application/rss+xml" href="../feed"><img src="../static/rss.png" alt="RSS Feed" title="RSS Feed" /></a>
                                <a href="https://www.facebook.com/miguelgrinbergblog"><img src="../static/facebook.png" alt="Facebook" title="Facebook" /></a>
                                <a href="https://plus.google.com/u/0/117786742456929977820"><img src="../static/googleplus.png" alt="Google+" title="Google+" /></a>
                                <a href="http://www.linkedin.com/in/miguelgrinberg"><img src="../static/linkedin.png" alt="LinkedIn" title="LinkedIn" /></a>
                                <a href="http://github.com/miguelgrinberg"><img src="../static/github.png" alt="GitHub" title="GitHub" /></a>
                                <a href="https://twitter.com/#!/miguelgrinberg"><img src="../static/twitter.png" alt="Twitter" title="Twitter" /></a>
                            </p>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
        
    </nav>

    
    <div class="container">
        <div class="row">
            <div class="col-md-4 col-md-push-9 sidebar-bg">
                <div id="sidebar">
                    

                    
                    <h1>An Introduction to Flask</h1>
                    <p>If you are a beginner giving your first steps in web development, my Flask introductory video is for you:</p>
                    <p><center><a href="http://bit.ly/flaskintro"><img style="border: 1px solid black;" src="../static/flask-intro-cover-tiny.png"></a></center></p>
                    <p>Visit <a href="http://flaskbook.com/">http://flaskbook.com</a> for information about this and other Flask training products I have created!</p>
                    

                    <h1>About Miguel</h1>
                    <img style="float: right; margin: 0px 8px 8px 0px; padding: 4px; border: 1px solid #ccc;" src="../static/miguel.jpg" />
                    <p>Welcome to my blog!</p>
                    <p>I'm a software engineer, photographer and filmmaker in Portland, Oregon, USA.</p>
                    <p>You can also find me on <a href="https://www.facebook.com/miguelgrinbergblog">Facebook</a>, <a href="https://plus.google.com/u/0/117786742456929977820">Google+</a>, <a href="http://www.linkedin.com/in/miguelgrinberg">LinkedIn</a>, <a href="https://github.com/miguelgrinberg">Github</a> and <a href="https://twitter.com/#!/miguelgrinberg">Twitter</a>.</p>
                    <p>Thank you for visiting!</p>

                    

                    
                    <h1>Categories</h1>
<ul>

	<li>
		<a href="../category/Arduino/feed">
			<img src="../static/rss-small.png" title="Arduino RSS Feed" label="Arduino RSS Feed" />
		</a>
		<span class="label label-primary"><a href="../category/Arduino.html">Arduino</a></span> (7)
	</li>

	<li>
		<a href="../category/Authentication/feed">
			<img src="../static/rss-small.png" title="Authentication RSS Feed" label="Authentication RSS Feed" />
		</a>
		<span class="label label-primary"><a href="../category/Authentication.html">Authentication</a></span> (4)
	</li>

	<li>
		<a href="../category/Blog/feed">
			<img src="../static/rss-small.png" title="Blog RSS Feed" label="Blog RSS Feed" />
		</a>
		<span class="label label-primary"><a href="../category/Blog.html">Blog</a></span> (1)
	</li>

	<li>
		<a href="../category/C%2b%2b/feed">
			<img src="../static/rss-small.png" title="C++ RSS Feed" label="C++ RSS Feed" />
		</a>
		<span class="label label-primary"><a href="../category/C%2b%2b.html">C++</a></span> (5)
	</li>

	<li>
		<a href="../category/Cloud/feed">
			<img src="../static/rss-small.png" title="Cloud RSS Feed" label="Cloud RSS Feed" />
		</a>
		<span class="label label-primary"><a href="../category/Cloud.html">Cloud</a></span> (2)
	</li>

	<li>
		<a href="../category/Filmmaking/feed">
			<img src="../static/rss-small.png" title="Filmmaking RSS Feed" label="Filmmaking RSS Feed" />
		</a>
		<span class="label label-primary"><a href="../category/Filmmaking.html">Filmmaking</a></span> (6)
	</li>

	<li>
		<a href="../category/Flask/feed">
			<img src="../static/rss-small.png" title="Flask RSS Feed" label="Flask RSS Feed" />
		</a>
		<span class="label label-primary"><a href="../category/Flask.html">Flask</a></span> (39)
	</li>

	<li>
		<a href="../category/Games/feed">
			<img src="../static/rss-small.png" title="Games RSS Feed" label="Games RSS Feed" />
		</a>
		<span class="label label-primary"><a href="../category/Games.html">Games</a></span> (1)
	</li>

	<li>
		<a href="../category/Gear/feed">
			<img src="../static/rss-small.png" title="Gear RSS Feed" label="Gear RSS Feed" />
		</a>
		<span class="label label-primary"><a href="../category/Gear.html">Gear</a></span> (6)
	</li>

	<li>
		<a href="../category/HTML5/feed">
			<img src="../static/rss-small.png" title="HTML5 RSS Feed" label="HTML5 RSS Feed" />
		</a>
		<span class="label label-primary"><a href="../category/HTML5.html">HTML5</a></span> (1)
	</li>

	<li>
		<a href="../category/Heroku/feed">
			<img src="../static/rss-small.png" title="Heroku RSS Feed" label="Heroku RSS Feed" />
		</a>
		<span class="label label-primary"><a href="../category/Heroku.html">Heroku</a></span> (1)
	</li>

	<li>
		<a href="../category/Javascript/feed">
			<img src="../static/rss-small.png" title="Javascript RSS Feed" label="Javascript RSS Feed" />
		</a>
		<span class="label label-primary"><a href="../category/Javascript.html">Javascript</a></span> (3)
	</li>

	<li>
		<a href="../category/Movie%20Reviews/feed">
			<img src="../static/rss-small.png" title="Movie Reviews RSS Feed" label="Movie Reviews RSS Feed" />
		</a>
		<span class="label label-primary"><a href="../category/Movie%20Reviews.html">Movie Reviews</a></span> (5)
	</li>

	<li>
		<a href="../category/Netflix/feed">
			<img src="../static/rss-small.png" title="Netflix RSS Feed" label="Netflix RSS Feed" />
		</a>
		<span class="label label-primary"><a href="../category/Netflix.html">Netflix</a></span> (5)
	</li>

	<li>
		<a href="../category/Node.js/feed">
			<img src="../static/rss-small.png" title="Node.js RSS Feed" label="Node.js RSS Feed" />
		</a>
		<span class="label label-primary"><a href="../category/Node.html">Node.js</a></span> (1)
	</li>

	<li>
		<a href="../category/OpenStack/feed">
			<img src="../static/rss-small.png" title="OpenStack RSS Feed" label="OpenStack RSS Feed" />
		</a>
		<span class="label label-primary"><a href="../category/OpenStack.html">OpenStack</a></span> (1)
	</li>

	<li>
		<a href="../category/Personal/feed">
			<img src="../static/rss-small.png" title="Personal RSS Feed" label="Personal RSS Feed" />
		</a>
		<span class="label label-primary"><a href="../category/Personal.html">Personal</a></span> (1)
	</li>

	<li>
		<a href="../category/Photography/feed">
			<img src="../static/rss-small.png" title="Photography RSS Feed" label="Photography RSS Feed" />
		</a>
		<span class="label label-primary"><a href="../category/Photography.html">Photography</a></span> (6)
	</li>

	<li>
		<a href="../category/Product%20Reviews/feed">
			<img src="../static/rss-small.png" title="Product Reviews RSS Feed" label="Product Reviews RSS Feed" />
		</a>
		<span class="label label-primary"><a href="../category/Product%20Reviews.html">Product Reviews</a></span> (1)
	</li>

	<li>
		<a href="../category/Programming/feed">
			<img src="../static/rss-small.png" title="Programming RSS Feed" label="Programming RSS Feed" />
		</a>
		<span class="label label-primary"><a href="../category/Programming.html">Programming</a></span> (47)
	</li>

	<li>
		<a href="../category/Project%20Management/feed">
			<img src="../static/rss-small.png" title="Project Management RSS Feed" label="Project Management RSS Feed" />
		</a>
		<span class="label label-primary"><a href="../category/Project%20Management.html">Project Management</a></span> (1)
	</li>

	<li>
		<a href="../category/Python/feed">
			<img src="../static/rss-small.png" title="Python RSS Feed" label="Python RSS Feed" />
		</a>
		<span class="label label-primary"><a href="../category/Python.html">Python</a></span> (43)
	</li>

	<li>
		<a href="../category/REST/feed">
			<img src="../static/rss-small.png" title="REST RSS Feed" label="REST RSS Feed" />
		</a>
		<span class="label label-primary"><a href="../category/REST.html">REST</a></span> (5)
	</li>

	<li>
		<a href="../category/Rackspace/feed">
			<img src="../static/rss-small.png" title="Rackspace RSS Feed" label="Rackspace RSS Feed" />
		</a>
		<span class="label label-primary"><a href="../category/Rackspace.html">Rackspace</a></span> (1)
	</li>

	<li>
		<a href="../category/Raspberry%20Pi/feed">
			<img src="../static/rss-small.png" title="Raspberry Pi RSS Feed" label="Raspberry Pi RSS Feed" />
		</a>
		<span class="label label-primary"><a href="../category/Raspberry%20Pi.html">Raspberry Pi</a></span> (6)
	</li>

	<li>
		<a href="../category/RhinoSteady/feed">
			<img src="../static/rss-small.png" title="RhinoSteady RSS Feed" label="RhinoSteady RSS Feed" />
		</a>
		<span class="label label-primary"><a href="../category/RhinoSteady.html">RhinoSteady</a></span> (6)
	</li>

	<li>
		<a href="../category/Robotics/feed">
			<img src="../static/rss-small.png" title="Robotics RSS Feed" label="Robotics RSS Feed" />
		</a>
		<span class="label label-primary"><a href="../category/Robotics.html">Robotics</a></span> (6)
	</li>

	<li>
		<a href="../category/Video/feed">
			<img src="../static/rss-small.png" title="Video RSS Feed" label="Video RSS Feed" />
		</a>
		<span class="label label-primary"><a href="../category/Video.html">Video</a></span> (4)
	</li>

	<li>
		<a href="../category/Windows/feed">
			<img src="../static/rss-small.png" title="Windows RSS Feed" label="Windows RSS Feed" />
		</a>
		<span class="label label-primary"><a href="../category/Windows.html">Windows</a></span> (1)
	</li>

</ul>
                    
                </div>
            </div>
            <div class="col-md-8 col-md-pull-4">
                <div id="main">
                    
                    
                    
                    
                    

<div class="post">

<p class="date"><span class="flask-moment" data-timestamp="2014-08-04T05:58:08Z" data-format="format('LL')" data-refresh="0">2014-08-04T05:58:08Z</span></p>
<h1 class="post-title"><a href="the-rackspace-cloud-api.html">The Rackspace Cloud API</a></h1>
<div class="posted">Posted by <span class="label label-danger"><a href="http://blog.miguelgrinberg.com/author/Miguel Grinberg">Miguel Grinberg</a></span> under <span class="label label-primary"><a href="../category/Cloud.html">Cloud</a></span>, <span class="label label-primary"><a href="../category/Python.html">Python</a></span>, <span class="label label-primary"><a href="../category/Rackspace.html">Rackspace</a></span>, <span class="label label-primary"><a href="../category/OpenStack.html">OpenStack</a></span>. </div>
<div class="social-bar">
    <table>
        <tr>
            <td><div class="social-box" style="padding-top: 8px;"><a href="https://twitter.com/share" class="twitter-share-button" data-url="http://blog.miguelgrinberg.com/post/the-rackspace-cloud-api" data-via="miguelgrinberg" data-count="vertical">Tweet</a></div></td>
            <td><div class="social-box" style="padding-left: 6px;"><div class="fb-like" data-href="http://blog.miguelgrinberg.com/post/the-rackspace-cloud-api" data-send="false" data-layout="box_count" data-width="450" data-show-faces="false" data-font="verdana"></div></div></td>
            <td><div class="social-box" style="padding-top: 8px;"><g:plusone href="the-rackspace-cloud-api.html" size="tall"></g:plusone></div></td>
            <td><div class="social-box" style="padding-top: 8px;"><script type="IN/Share" data-url="http://blog.miguelgrinberg.com/post/the-rackspace-cloud-api" data-counter="top"></script></div></td>
        </tr>
    </table>
</div>
<div class="post_body"><p>Most of you know by now that not too long ago I joined <a href="http://rackspace.com/">Rackspace</a>. As you can imagine, I am now learning tons of new things as I familiarize myself with all the OpenStack projects, none of which I have used before.</p>
<p>In this article I'm going to show you a few ways to work more efficiently with your Rackspace cloud account (or any OpenStack cloud for that matter). I will begin with the introduction of a command line tool that you can use to manage your cloud servers, and then go even lower level and show you how you can do the same thing using a Python SDK. To end this article I'm going to show you a complete script that creates a cloud server, configures it as a Web server and deploys a Flask application to it, all completely unattended.</p>
<h2>Why do it?</h2>
<p>As a developer, being able to spin up a clean server instance to run a given process or application with just a few keystrokes is invaluable, as is to destroy it when I'm done. Having scripted access to my cloud account gives me the ability to include the server provisioning right in my scripts to help me create a fully automated experience.</p>
<h2>Using the "nova" command line client</h2>
<p>The <code>nova</code> command line client gives you access to the compute resources in your cloud account with simple commands. This tool is written in Python, so you need a Python interpreter installed on your system to use it. Assuming you have Python and the <code>pip</code> package manager installed, then you can download and install <code>nova</code> with the following command:</p>
<pre><code>$ pip install rackspace-novaclient
</code></pre>
<p>Note that the above command will install the open source <code>nova</code> client with the Rackspace extensions to it. If you need help with installation issues I recommend that you review the installation instructions in the <a href="http://docs.rackspace.com/servers/api/v2/cs-gettingstarted/content/section_gs_install_nova.html">Getting Started Guide</a>.</p>
<p>Before you can use <code>nova</code> you have to define a few environment variables that will be used to authenticate you with the cloud services. If you are using a bash shell or similar, then you can add the following lines to your <em>~/.bash_profile</em> file:</p>
<pre><code>export OS_AUTH_URL=https://identity.api.rackspacecloud.com/v2.0/
export OS_AUTH_SYSTEM=rackspace
export OS_USERNAME=&lt;your username&gt;
export OS_PASSWORD=&lt;your API key&gt;
export OS_TENANT_NAME=&lt;your account number&gt;
export OS_PROJECT_ID=&lt;your account number&gt;
export OS_REGION_NAME=&lt;your desired region&gt;
export NOVA_RAX_AUTH=1
export OS_NO_CACHE=1
</code></pre>
<p>Note that if you are not authenticating to a Rackspace cloud you will need to change some of the values above to the appropriate ones for your OpenStack cloud. Also for those of you that are on a Windows machine be aware that you will need to adapt the above assignments to the form <code>set VAR=&lt;value&gt;</code>.</p>
<p>It is important to note that Rackspace needs the <code>OS_PASSWORD</code> variable to be set to your API key, not your account password (it would be a terrible idea to have your account password exposed in a config file!). You can find your API key in the Web portal, in the Account Settings page.</p>
<p>Another piece of information you need is your Rackspace account number, which appears when you expand the dropdown at the top right corner of the navigation bar in the Web portal.</p>
<p>Finally, each session is attached to a specific Rackspace data center, so you need to choose what region you want to authenticate to, using the three letter code for it (i.e. DFW for Dallas, LON for London and so on).</p>
<h3>Listing your servers</h3>
<p>With all these variables set in your environment you are ready to use <code>nova</code>. To see the list of servers active in your account for the chosen region, run the following command:</p>
<pre><code>$ nova list
</code></pre>
<h3>Flavors</h3>
<p>If you used the Web portal to create cloud servers you know that one of the decisions you need to make when you create a new server is what <em>flavor</em> to use for it. The flavor that you choose determines the specs of your server, and directly related to that, its cost. The same flavor options you have in the Web portal are available from <code>nova</code>. You can obtain the complete list of supported flavors with the following command:</p>
<pre><code>$ nova flavor-list
</code></pre>
<p>Each flavor listed will have an ID associated with it, which you will need later when I show you how to create a new server.</p>
<h3>Images</h3>
<p>Another decision you need to make before you create a new server is what <em>image</em> to install in it. Rackspace offers images for most operating systems. The complete list can be obtained with this command:</p>
<pre><code>$ nova image-list
</code></pre>
<p>As with the flavors, images have an ID associated with them.</p>
<h3>Keypairs</h3>
<p>This is entirely optional, but it is useful to have your SSH public key installed on new servers during creation, so that you can use a password-less login from the start. You can upload your public key(s) in the Web portal, but <code>nova</code> includes a full set of management commands for keypairs as well:</p>
<pre><code>$ nova keypair-list
$ nova keypair-show &lt;key-name&gt;
$ nova keypair-add --pub-key &lt;pub-key-file&gt; &lt;key-name&gt;
$ nova keypair-delete &lt;key-name&gt;
</code></pre>
<h3>Booting a new server</h3>
<p>Once you have a flavor and an image selected, you can bring a new server to life with the following command:</p>
<pre><code>$ nova boot my_new_server --image &lt;image-id&gt; --flavor &lt;flavor-id&gt; [--key-name &lt;key-name&gt;]
</code></pre>
<p>Yes, it's that simple! Note that <code>nova boot</code> is an asynchronous command, it normally takes a minute or two for the server to be ready. </p>
<p>The output of the <code>nova boot</code> command will show a few pieces of information that are very useful, so while you wait for your server to be created write down the <code>adminPass</code> value (the root password of your server) and the <code>id</code> your server was assigned, which you will use to query its status.</p>
<p>To find out if your server is ready to use you can issue the following command:</p>
<pre><code>$ nova show &lt;server-id&gt;
</code></pre>
<p>When the status of your server appears as active you are ready to roll. The output of <code>nova show</code> will include the IP address that was assigned to the server on the public network. Using this IP address and either your SSH key or the root password you wrote down earlier you can SSH into your server and start using it.</p>
<p>It's important to note that once you create a server you start incurring in charges. If you create a server just to run some short tasks, do not forget to delete it when you are done, because if not it will continue to generate exposes, even if you don't use it. The command to delete a server is:</p>
<pre><code>$ nova delete &lt;server-id&gt;
</code></pre>
<h2>Using the Python SDK</h2>
<p>The <code>nova</code> client is fun to use, but using it in scripts to automate your workflows requires that you add some logic to parse the command output and scrape the useful bits, and that makes it not fun anymore.</p>
<p>For a complete and very rewarding automation experience nothing beats connecting directly to the Rackspace API. The examples I'm going to show you are written in Python (we seem to like Python a lot at Rackspace). But note that you don't have to use Python, as there are SDKs for several other languages as well, and they all work in a similar way. Head over to the <a href="https://developer.rackspace.com/sdks/">SDK documentation page</a> for more information.</p>
<p>To install the Rackspace SDK for Python you can use <code>pip</code>:</p>
<pre><code>$ pip install pyrax
</code></pre>
<p>Note that you may need to run the command above on an account with administration rights, or else you have the option to create a Python virtual environment and install locally to it.</p>
<h3>Listing your servers</h3>
<p>Assuming you kept your <code>OS_*</code> environment variables that you were using with <code>nova</code>, here is a short Python script that shows the id, name and status of all your cloud servers:</p>
<pre><code>#!/usr/bin/env python
import os
import pyrax

pyrax.set_setting('identity_type', os.environ['OS_AUTH_SYSTEM'])
pyrax.set_default_region(os.environ['OS_REGION_NAME'])
pyrax.set_credentials(os.environ['OS_USERNAME'], os.environ['OS_PASSWORD'])
nova = pyrax.cloudservers

for server in nova.servers.list():       
    print(server.id, server.name, server.status)
</code></pre>
<p>If you store the above script in a file named <code>list-servers.py</code> then you can execute it as follows:</p>
<pre><code>$ python list-servers.py
</code></pre>
<p>If you are on Unix or OS X you can also make this file executable with <code>chmod +x list-servers.py</code> and then run it directly as a command:</p>
<pre><code>$ ./list-servers.py
</code></pre>
<p>There are a couple important notes to make about this example. The <code>pyrax.cloudservers</code> object is not Rackspace specific, it is a <code>Client</code> instance, from the <a href="http://docs.openstack.org/developer/python-novaclient/api.html">novaclient</a> open source project. Anything you do with this object can be translated to other OpenStack based clouds. You can even install <a href="http://devstack.org/">DevStack</a> on your computer and test your scripts against it!</p>
<p>The other note I wanted to make is that the <code>Server</code> objects returned by <code>list()</code> have more information available to you. See the <a href="http://docs.openstack.org/developer/python-novaclient/ref/v1_1/servers.html">documentation</a> if you want to see what you can do with them.</p>
<h3>Flavors and Images</h3>
<p>We've seen above how to obtain the list of flavors using <code>nova</code>. Here is a <code>list-flavors.py</code> script that achieves the same goal:</p>
<pre><code>#!/usr/bin/env python
import os
import pyrax

pyrax.set_setting('identity_type', os.environ['OS_AUTH_SYSTEM'])
pyrax.set_default_region(os.environ['OS_REGION_NAME'])
pyrax.set_credentials(os.environ['OS_USERNAME'], os.environ['OS_PASSWORD'])
nova = pyrax.cloudservers

for flavor in nova.flavors.list():
    print(flavor.id, flavor.name)
</code></pre>
<p>And following the same style we can write a <code>list-images.py</code> script to list images:</p>
<pre><code>#!/usr/bin/env python
import os
import pyrax

pyrax.set_setting('identity_type', os.environ['OS_AUTH_SYSTEM'])
pyrax.set_default_region(os.environ['OS_REGION_NAME'])
pyrax.set_credentials(os.environ['OS_USERNAME'], os.environ['OS_PASSWORD'])
nova = pyrax.cloudservers

for image in nova.images.list():
    print(image.id, image.name)
</code></pre>
<p>Like with servers, the <code>Flavor</code> and <code>Image</code> objects have a number of additional properties and methods.</p>
<h3>Creating a server</h3>
<p>Creating a cloud server using the nova APIs requires a script that is a bit longer than the ones we've been using so far, but the process is still fairly simple. Here is a script that creates a low-end Ubuntu 14.04 server named "my-server":</p>
<pre><code>#!/usr/bin/env python
import os
import sys
import time
import re
import pyrax

pyrax.set_setting('identity_type', os.environ['OS_AUTH_SYSTEM'])
pyrax.set_default_region(os.environ['OS_REGION_NAME'])
pyrax.set_credentials(os.environ['OS_USERNAME'], os.environ['OS_PASSWORD'])
nova = pyrax.cloudservers

flavor = nova.flavors.find(name='512MB Standard Instance')
image = nova.images.find(name='Ubuntu 14.04 LTS (Trusty Tahr)')
key_name = None  # set your public key name here!

# create the server
server = nova.servers.create(name='my-server', flavor=flavor.id,
                             image=image.id, key_name=key_name)
print 'Building, please wait...'

# wait for server create to be complete
while server.status == 'BUILD':
    time.sleep(5)
    server = nova.servers.get(server.id)  # refresh server

# check for errors
if server.status != 'ACTIVE':
    print 'ERROR!'
    sys.exit(1)

# the server was assigned IPv4 and IPv6 addresses, locate the IPv4 address
ip_address = None
for network in server.networks['public']:
    if re.match('\d+\.\d+\.\d+\.\d+', network):
        ip_address = network
        break
if ip_address is None:
    print 'No IP address assigned!'
    sys.exit(1)
print 'The server is waiting at IP address {0}.'.format(ip_address)
</code></pre>
<p>In this script you can see how it is possible to find flavors or images by name using the <code>find()</code> method. Also recall that server creation is an asynchronous task, so we need to wait for the server to reach the <code>"ACTIVE"</code> state before it can be used. Once the server is ready we need to do a little bit of regex parsing to locate the IPv4 address was assigned to it.</p>
<h3>Deleting a server</h3>
<p>The other important operation you may need to automate is server destruction. Below is a script that deletes the server created above, waiting until the operation is complete:</p>
<pre><code>#!/usr/bin/env python
import os
import time
import pyrax
from novaclient.exceptions import NotFound

pyrax.set_setting('identity_type', os.environ['OS_AUTH_SYSTEM'])
pyrax.set_default_region(os.environ['OS_REGION_NAME'])
pyrax.set_credentials(os.environ['OS_USERNAME'], os.environ['OS_PASSWORD'])
nova = pyrax.cloudservers

# find the server by name
server = nova.servers.find(name='my-server')
server.delete()
print 'Deleting, please wait...'

# wait for server to be deleted
try:
    while True:
        server = nova.servers.get(server.id)
        time.sleep(5)
except NotFound:
    pass
print 'The server has been deleted.'
</code></pre>
<h2>A complete example</h2>
<p>This was all too easy, right? In this section I present a practical application of the techniques I showed you above. We are going to write a script that creates a cloud server, configures it as a web server, and finally deploys a Python web application to it, all unattended. After this script runs you will have a fully enabled website online that you can connect to with a web browser from anywhere in the world!</p>
<p>You probably know that <a href="http://flaskbook.com/">I like Flask very much</a>, so for this example I'm going to deploy Flasky, the social blogging application featured in my book, straight from its <a href="https://github.com/miguelgrinberg/flasky">GitHub project</a>. To run the installation steps in the server I will use the Python package <a href="https://github.com/paramiko/paramiko">paramiko</a> to create a SSH connection to the server. To install <code>paramiko</code> you need to run the following command:</p>
<pre><code>$ pip install paramiko
</code></pre>
<p>The following sections describe the different parts of this deployment script, which is actually two, though in my defense the first script calls the second automatically. You can download the two complete scripts from <a href="https://gist.github.com/miguelgrinberg/d9f1fcafc012f3fb3f03">this gist</a>.</p>
<h3>The main function</h3>
<p>I called the deployment script <code>rackspace-flasky.py</code>. When this script executes it invokes the <code>main()</code> function. You can see this function below:</p>
<pre><code>def main():
    args = process_args()
    gmail_password = getpass('gmail password: ')

    # instantiate the nova client
    global nova
    pyrax.set_setting('identity_type', os.environ['OS_AUTH_SYSTEM'])
    pyrax.set_default_region(os.environ['OS_REGION_NAME'])
    pyrax.set_credentials(os.environ['OS_USERNAME'], os.environ['OS_PASSWORD'])
    nova = pyrax.cloudservers

    flavor = get_flavor(args.flavor)
    image = get_image(args.image)

    ip_address = create_web_server(flavor, image, args.key_name)
    install_flasky(ip_address, args.gmail_username, gmail_password)
    print 'Flasky is now running at http://{0}.'.format(ip_address)
</code></pre>
<p>So as you can see here the script begins by processing the command line arguments. Function <code>process_args()</code> uses <code>argparse</code> for this task and is not interesting enough to show here. Below you can see the help message it generates:</p>
<pre><code>$ ./rackspace-flasky.py --help
usage: rackspace-flasky.py [-h] [--flavor FLAVOR] [--image IMAGE]
                           KEY_NAME GMAIL_USERNAME

Deploy Flasky to a Rackspace cloud server.

positional arguments:
  KEY_NAME              Keypair name to install on the server. Must be
                        uploaded to your cloud account in advance.
  GMAIL_USERNAME        The username of the gmail account that the web app
                        will use to send emails.

optional arguments:
  -h, --help            show this help message and exit
  --flavor FLAVOR, -f FLAVOR
                        Flavor to use for the instance.Default is 512MB
                        Standard Instance.
  --image IMAGE, -i IMAGE
                        Image to use for the server. Default is Ubuntu 14.04.
</code></pre>
<p>The only two required arguments are the public key name to install on the new server and a username for a Gmail account. Flasky, the application I'm going to install, sends emails to users at different times. The easiest way to allow it to send emails is to use a Gmail account for that task. In a real production server you would have your own email server instead, since Gmail has quotas that may prevent you from sending all the emails that you need to send.</p>
<p>The password to the Gmail account is not given in the command line for security reasons, and instead is requested using Python's package <code>getpass</code>.</p>
<p>After all the arguments have been collected the script instantiates a <code>nova</code> client object, relying on the <code>OS_*</code> variables in the environment as we did before. The client object is stored in a global variable, so that all functions in this script can access it.</p>
<p>Next we retrieve the flavor and image objects, using the names given as command line arguments. These are very simple functions, shown below:</p>
<pre><code>def get_flavor(name):
    return nova.flavors.find(name=name)

def get_image(name):
    return nova.images.find(name=name)
</code></pre>
<p>To complete the process, <code>create_web_server()</code> deals with the creation of the cloud server, while function <code>install_flasky()</code> transforms the clean instance into a complete web server. These two functions are described in the following sections.</p>
<h3>Server creation</h3>
<p>The function that creates the cloud server is not going to be a surprise for you, as it is very similar to the one we've seen before:</p>
<pre><code>def create_web_server(flavor=None, image=None, key_name=None):
    server = nova.servers.create(name='flasky', flavor=flavor.id,
                                 image=image.id, key_name=key_name)
    print 'Building, please wait...'

    # wait for server create to be complete
    while server.status == 'BUILD':
        time.sleep(5)
        server = nova.servers.get(server.id)  # refresh server

    # check for errors
    if server.status != 'ACTIVE':
        raise RuntimeError('Server did not boot, status=' + server.status)

    # the server was assigned IPv4 and IPv6 addresses, locate the IPv4 address
    ip_address = None
    for network in server.networks['public']:
        if re.match('\d+\.\d+\.\d+\.\d+', network):
            ip_address = network
            break
    if ip_address is None:
        raise RuntimeError('No IP address assigned!')
    print 'Server is running at IP address ' + ip_address
    return ip_address
</code></pre>
<h3>Server configuration</h3>
<p>This is the function that connects to the cloud server and runs the installer for Flasky:</p>
<pre><code>def install_flasky(ip_address, gmail_username, gmail_password):
    print 'Installing Flasky...'

    # establish a SSH connection
    ssh = paramiko.SSHClient()
    ssh.set_missing_host_key_policy(paramiko.AutoAddPolicy())
    ssh.load_system_host_keys()
    retries_left = 3
    while True:
        try:
            ssh.connect(ip_address, username='root')
            break
        except socket_error as e:
            if e.errno != errno.ECONNREFUSED or retries_left &lt;= 1:
                raise e
        time.sleep(10)  # wait 10 seconds and retry
        retries_left -= 1

    # upload deployment script
    ftp = ssh.open_sftp()
    ftp.put('install-flasky.sh', 'install-flasky.sh')
    ftp.chmod('install-flasky.sh', 0544)

    # deploy
    stdin, stdout, stderr = ssh.exec_command(
        './install-flasky.sh "{0}" "{1}"'.format(
            gmail_username, gmail_password))
    status = stdout.channel.recv_exit_status()
    open('stdout.log', 'wt').write(stdout.read())
    open('stderr.log', 'wt').write(stderr.read())
    if status != 0:
        raise RuntimeError(
            'Deployment script returned status {0}.'.format(status))
</code></pre>
<p>As you can see, I'm using <code>paramiko</code> to establish a SSH connection to the server. A password is not required because the server creation function installed the public key. In this function paramiko reads the corresponding private key from the default location, which on a Unix based system is <code>~/.ssh/</code>.</p>
<p>I have found that even when the Rackspace API reports the server as active it may take a few seconds for SSH to respond to requests. For that reason I allow up to three retries to the <code>connect()</code> function, separated by 10 seconds of wait.</p>
<p>Once the SSH link is established I use SFTP to upload a bash script called <code>install-flasky.sh</code> to the server, and then execute it. In case there are problems, the <code>stdout</code> and <code>stderr</code> output from the command running on the cloud server are saved to files <code>stdout.log</code> and <code>stderr.log</code>.</p>
<h3>Remote installer script</h3>
<p>I'm not going to show the installer script here because it is largely unrelated to the topic of this article, but you can view it, along with the main Python script, <a href="https://gist.github.com/miguelgrinberg/d9f1fcafc012f3fb3f03">here</a>.</p>
<p>The script takes two arguments, the Gmail username and password for Flasky to use when sending emails. The actions performed by this script are listed below, you can easily find the proper sections in the script if you are interested in learning more:</p>
<ul>
<li>Install dependencies, such as git, nginx and supervisor</li>
<li>Create a <code>flasky</code> user</li>
<li>Clone the Flasky application from the public GitHub repository</li>
<li>Create a configuration file for Flasky with the Gmail credentials and other variables.</li>
<li>Create a Python virtualenv and install all the Flasky dependencies in it.</li>
<li>Install Gunicorn, the web server that will run Flasky.</li>
<li>Run the Flasky setup function to create and populate the database.</li>
<li>Install a config file for supervisor to monitor Gunicorn. The command that runs Flasky is given here.</li>
<li>Install a config file for nginx. This is the front-end web server. It serves static files directly and proxies dynamic requests to the Gunicorn server.</li>
</ul>
<h2>Conclusion</h2>
<p>I hope you decide to give this little project a try. If you do, then remember to set your <code>OS_*</code> environment variables, as this script authenticates to the Rackspace cloud APIs with them. </p>
<p>As I mentioned above, the two required files are in a gist <a href="https://gist.github.com/miguelgrinberg/d9f1fcafc012f3fb3f03">here</a>. Below is an example run of the script:</p>
<pre><code>(venv) $ ./rackspace-flasky.py &lt;key-name&gt; &lt;gmail-username&gt;
gmail password: &lt;gmail-password&gt;
Building, please wait...
Server is running at IP address 162.242.209.20
Installing Flasky...
Flasky is now running at http://162.242.209.20.
</code></pre>
<p>Once you verify that the server is running and everything is all right don't forget to delete the server, if not it will continue to generate charges to your account.</p>
<p>I hope this article piqued your interest enough that you decide to give the cloud a try. To find more information you can always head over to the <a href="https://developer.rackspace.com/">Rackspace Developer page</a>, where you will find documentation for all the APIs and SDKs, or else go to the ultimate source, at <a href="http://openstack.org/">openstack.org</a>.</p>
<p>In future posts I will cover other cloud related topics such as scaling, load balancing and whatever else I find worthy of mention during my travels through the land of OpenStack.</p>
<p>Miguel</p></div>
<div class="social-bar">
    <table>
        <tr>
            <td><div class="social-box" style="padding-top: 8px;"><a href="https://twitter.com/share" class="twitter-share-button" data-url="http://blog.miguelgrinberg.com/post/the-rackspace-cloud-api" data-via="miguelgrinberg" data-count="vertical">Tweet</a></div></td>
            <td><div class="social-box" style="padding-left: 6px;"><div class="fb-like" data-href="http://blog.miguelgrinberg.com/post/the-rackspace-cloud-api" data-send="false" data-layout="box_count" data-width="450" data-show-faces="false" data-font="verdana"></div></div></td>
            <td><div class="social-box" style="padding-top: 8px;"><g:plusone href="the-rackspace-cloud-api.html" size="tall"></g:plusone></div></td>
            <td><div class="social-box" style="padding-top: 8px;"><script type="IN/Share" data-url="http://blog.miguelgrinberg.com/post/the-rackspace-cloud-api" data-counter="top"></script></div></td>
        </tr>
    </table>
</div>


<h4 style="text-align: right"><a name="comments"></a>1 comment</h4>


<div class="comment">
    <ul>
        
        <li>
            <div class="comment-thumbnail"><img src="../../gravatar.com/avatar/3379b07091198e7e03cac45b9826bc9bce2c.jpeg?s=60&amp;d=identicon" /></div>
            <div class="comment-body">
                <p>
                    <span class="label label-default">#1</span> <span class="label label-primary">Dylan</span> said
                    <span class="flask-moment" data-timestamp="2015-03-04T08:13:14Z" data-format="fromNow(0)" data-refresh="0">2015-03-04T08:13:14Z</span>
                </p>
                <div style="overflow: auto;">
                    <p style="white-space: pre-wrap;">Fantastic example, very clear and helpful!  Also, congrats on becoming a Racker.</p>
                </div>
            </div>
        </li>
        
    </ul>
</div>

<div class="page">
<ul class="pager">
  <li class="previous disabled">
    <a href="#">&laquo;&laquo;</a>
  </li>
  <li class="previous disabled">
    <a href="#">&laquo;</a>
  </li>
  <li class="next disabled">
    <a href="#">&raquo;&raquo;</a>
  </li>
  <li class="next disabled">
    <a href="#">&raquo;</a>
  </li>
</ul>
</div>

<h3><a name="commentform"></a>Leave a Comment</h3>

<form action="#commentform" method="post"
  class="form" role="form">
  <div style="display:none;"><input id="csrf_token" name="csrf_token" type="hidden" value="1439536732.61##2c224b495e78cfd95e1b89c3e9405443568a659b"></div>
  
    
    






<div class="form-group "><label class="control-label" for="name">Name</label>
        <input class="form-control" id="name" name="name" required type="text" value="">
  </div>


    




<div class="form-group "><label class="control-label" for="url">URL</label>
        <input class="form-control" id="url" name="url" type="text" value="">
  </div>


    






<div class="form-group "><label class="control-label" for="email">Email</label>
        <input class="form-control" id="email" name="email" required type="text" value="">
  </div>


    






<div class="form-group "><label class="control-label" for="comment">Comment</label>
        <textarea class="form-control" id="comment" name="comment" required></textarea>
  </div>


    




<div class="form-group "><label class="control-label" for="captcha">Captcha</label>
        
<script type="text/javascript">var RecaptchaOptions = {"custom_translations": {"audio_challenge": "Get an audio challenge", "cant_hear_this": "Download sound as MP3", "help_btn": "Help", "image_alt_text": "reCAPTCHA challenge image", "incorrect_try_again": "Incorrect. Try again.", "instructions_audio": "Type what you hear", "instructions_visual": "Type the text", "play_again": "Play sound again", "privacy_and_terms": "Privacy & Terms", "refresh_btn": "Get a new challenge", "visual_challenge": "Get a visual challenge"}, "theme": "white"};</script>
<script type="text/javascript" src="http://www.google.com/recaptcha/api/challenge?k=6Ld5Zs4SAAAAAOY0DOi4r18bgHlEaz41qAoRf__S"></script>
<noscript>
  <iframe src="http://www.google.com/recaptcha/api/noscript?k=6Ld5Zs4SAAAAAOY0DOi4r18bgHlEaz41qAoRf__S" height="300" width="500" frameborder="0"></iframe><br>
  <textarea name="recaptcha_challenge_field" rows="3" cols="40"></textarea>
  <input type="hidden" name="recaptcha_response_field" value="manual_challenge">
</noscript>

  </div>


    





  


    <input class="btn btn-default" id="submit" name="submit" type="submit" value="Submit">
  





</form>


</div>

                </div>
            </div>
        </div>
        <div id="footer">
            <p class="elapsed">This page was generated in None seconds.</p>
            <p>&copy; 2014 by Miguel Grinberg. All rights reserved. <a href="mailto:webmaster _at_ miguelgrinberg _dot_ com">Questions?</a></p>
        </div>
    </div>


    
    
    <script src="../../cdnjs.cloudflare.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
    <script src="../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.0/js/bootstrap.min.js"></script>
	<script type="text/javascript" src="../../cdnjs.cloudflare.com/ajax/libs/jquery.colorbox/1.4.33/jquery.colorbox-min.js"></script>
    <script type="text/javascript" src="../static/prettify.js"></script>
    <script src="../../cdnjs.cloudflare.com/ajax/libs/moment.js/2.5.1/moment-with-langs.min.js"></script>
<script>
function flask_moment_render(elem) {
    $(elem).text(eval('moment("' + $(elem).data('timestamp') + '").' + $(elem).data('format') + ';'));
    $(elem).removeClass('flask-moment');
}
function flask_moment_render_all() {
    $('.flask-moment').each(function() {
        flask_moment_render(this);
        if ($(this).data('refresh')) {
            (function(elem, interval) { setInterval(function() { flask_moment_render(elem) }, interval); })(this, $(this).data('refresh'));
        }
    })
}
$(document).ready(function() {
    flask_moment_render_all();
});
</script>
    
    <script type="text/javascript">
      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-4777284-15']);
      _gaq.push(['_trackPageview']);

      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();
    </script>
    
    <script type="text/javascript">
        $(document).ready(function(){
            $(".gallery").colorbox({rel:".gallery",maxWidth:"95%",maxHeight:"95%",scalePhotos:true});
            // add prettyprint class to all <pre><code></code></pre> blocks
            var prettify = false;
            $("pre code").parent().each(function() {
                $(this).addClass('prettyprint');
                prettify = true;
            });
            prettyPrint();
        });
    </script>


  </body>

<!-- Mirrored from blog.miguelgrinberg.com/post/the-rackspace-cloud-api by HTTrack Website Copier/3.x [XR&CO'2014], Fri, 14 Aug 2015 06:43:49 GMT -->
</html>
