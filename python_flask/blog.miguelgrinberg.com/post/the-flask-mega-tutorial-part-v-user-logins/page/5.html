<!DOCTYPE html>
<html>
  
<!-- Mirrored from blog.miguelgrinberg.com/post/the-flask-mega-tutorial-part-v-user-logins/page/5 by HTTrack Website Copier/3.x [XR&CO'2014], Fri, 14 Aug 2015 06:14:52 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head>
    
    <title>
    
        The Flask Mega-Tutorial, Part V: User Logins - miguelgrinberg.com
    
</title>
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
	<meta name="description" content="miguelgrinberg.com">
	<meta name="copyright" content="Copyright (c) 2012-2015 Miguel Grinberg">
	<meta name="author" content="Miguel Grinberg">
    
    <meta name="keywords" content="python, programming, flask, web, tutorial, database, sqlalchemy">
    

    
    <!-- Bootstrap -->
    <link href="../../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.0/css/bootstrap.min.css" rel="stylesheet" media="screen">
    <link href="../../../static/prettify.css" type="text/css" rel="stylesheet" />
    <link href="../../../static/colorbox/colorbox.css" rel="stylesheet" type="text/css" />
    <link href="../../../static/style.css" rel="stylesheet" type="text/css" />

    <link rel="shortcut icon" href="../../../static/favicon.ico">
	<link rel="alternate" type="application/rss+xml" href="../../../feed" title="miguelgrinberg.com RSS feed">

  </head>
  <body>
    
    <!-- facebook sdk -->
    <div id="fb-root"></div>
    <script>(function(d, s, id) {
      var js, fjs = d.getElementsByTagName(s)[0];
      if (d.getElementById(id)) return;
      js = d.createElement(s); js.id = id;
      js.src = "../../../../connect.facebook.net/en_US/all.js#xfbml=1";
      fjs.parentNode.insertBefore(js, fjs);
    }(document, 'script', 'facebook-jssdk'));</script>
    <!-- google plus sdk -->
    <script type="text/javascript" src="../../../../apis.google.com/js/plusone.js"></script>
    <!-- twitter sdk -->
    <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="../../../../platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>
    <!-- linkedin sdk -->
    <script src="../../../../platform.linkedin.com/in.js" type="text/javascript"></script>

    
    <nav class="navbar navbar-default" role="navigation">
        <div class="container-fluid">
            <div class="container">
                <div class="navbar-header">
                    <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                        <span class="sr-only">Toggle navigation</span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </button>
                    <a class="navbar-brand" href="http://blog.miguelgrinberg.com/index">miguelgrinberg.com</a>
                </div>
                <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
                    <ul class="nav navbar-nav">
                        <li><a href="http://blog.miguelgrinberg.com/index">Home</a></li>
                        <li><a href="../../about-me.html">About Me</a></li>
                        <li><a href="../../about-this-blog.html">About This Blog</a></li>
                        
                    </ul>
                    <ul class="nav navbar-nav navbar-right">
                        <li>
                            <p class="navbar-text" style="margin-top: 10px; margin-bottom: 0px;">
                                <a type="application/rss+xml" href="../../../feed"><img src="../../../static/rss.png" alt="RSS Feed" title="RSS Feed" /></a>
                                <a href="https://www.facebook.com/miguelgrinbergblog"><img src="../../../static/facebook.png" alt="Facebook" title="Facebook" /></a>
                                <a href="https://plus.google.com/u/0/117786742456929977820"><img src="../../../static/googleplus.png" alt="Google+" title="Google+" /></a>
                                <a href="http://www.linkedin.com/in/miguelgrinberg"><img src="../../../static/linkedin.png" alt="LinkedIn" title="LinkedIn" /></a>
                                <a href="http://github.com/miguelgrinberg"><img src="../../../static/github.png" alt="GitHub" title="GitHub" /></a>
                                <a href="https://twitter.com/#!/miguelgrinberg"><img src="../../../static/twitter.png" alt="Twitter" title="Twitter" /></a>
                            </p>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
        
    </nav>

    
    <div class="container">
        <div class="row">
            <div class="col-md-4 col-md-push-9 sidebar-bg">
                <div id="sidebar">
                    

                    
                    <h1>Building Web APIs with Flask</h1>
                    <p>Flask is the ideal Python framework for building REST APIs that are flexible, easy to maintain and efficient. I have created a training video with O'Reilly in which I show all my techniques:</p>
                    <p><center><a href="http://bit.ly/flaskapi"><img style="border: 1px solid black;" src="../../../static/flask-api-cover-tiny.png"></a></center></p>
                    <p>Visit <a href="http://flaskbook.com/">http://flaskbook.com</a> for information about this and other Flask training products I have created!</p>
                    

                    <h1>About Miguel</h1>
                    <img style="float: right; margin: 0px 8px 8px 0px; padding: 4px; border: 1px solid #ccc;" src="../../../static/miguel.jpg" />
                    <p>Welcome to my blog!</p>
                    <p>I'm a software engineer, photographer and filmmaker in Portland, Oregon, USA.</p>
                    <p>You can also find me on <a href="https://www.facebook.com/miguelgrinbergblog">Facebook</a>, <a href="https://plus.google.com/u/0/117786742456929977820">Google+</a>, <a href="http://www.linkedin.com/in/miguelgrinberg">LinkedIn</a>, <a href="https://github.com/miguelgrinberg">Github</a> and <a href="https://twitter.com/#!/miguelgrinberg">Twitter</a>.</p>
                    <p>Thank you for visiting!</p>

                    

                    
                    <h1>Categories</h1>
<ul>

	<li>
		<a href="../../../category/Arduino/feed">
			<img src="../../../static/rss-small.png" title="Arduino RSS Feed" label="Arduino RSS Feed" />
		</a>
		<span class="label label-primary"><a href="../../../category/Arduino.html">Arduino</a></span> (7)
	</li>

	<li>
		<a href="../../../category/Authentication/feed">
			<img src="../../../static/rss-small.png" title="Authentication RSS Feed" label="Authentication RSS Feed" />
		</a>
		<span class="label label-primary"><a href="../../../category/Authentication.html">Authentication</a></span> (4)
	</li>

	<li>
		<a href="../../../category/Blog/feed">
			<img src="../../../static/rss-small.png" title="Blog RSS Feed" label="Blog RSS Feed" />
		</a>
		<span class="label label-primary"><a href="../../../category/Blog.html">Blog</a></span> (1)
	</li>

	<li>
		<a href="../../../category/C%2b%2b/feed">
			<img src="../../../static/rss-small.png" title="C++ RSS Feed" label="C++ RSS Feed" />
		</a>
		<span class="label label-primary"><a href="../../../category/C%2b%2b.html">C++</a></span> (5)
	</li>

	<li>
		<a href="../../../category/Cloud/feed">
			<img src="../../../static/rss-small.png" title="Cloud RSS Feed" label="Cloud RSS Feed" />
		</a>
		<span class="label label-primary"><a href="../../../category/Cloud.html">Cloud</a></span> (2)
	</li>

	<li>
		<a href="../../../category/Filmmaking/feed">
			<img src="../../../static/rss-small.png" title="Filmmaking RSS Feed" label="Filmmaking RSS Feed" />
		</a>
		<span class="label label-primary"><a href="../../../category/Filmmaking.html">Filmmaking</a></span> (6)
	</li>

	<li>
		<a href="../../../category/Flask/feed">
			<img src="../../../static/rss-small.png" title="Flask RSS Feed" label="Flask RSS Feed" />
		</a>
		<span class="label label-primary"><a href="../../../category/Flask.html">Flask</a></span> (39)
	</li>

	<li>
		<a href="../../../category/Games/feed">
			<img src="../../../static/rss-small.png" title="Games RSS Feed" label="Games RSS Feed" />
		</a>
		<span class="label label-primary"><a href="../../../category/Games.html">Games</a></span> (1)
	</li>

	<li>
		<a href="../../../category/Gear/feed">
			<img src="../../../static/rss-small.png" title="Gear RSS Feed" label="Gear RSS Feed" />
		</a>
		<span class="label label-primary"><a href="../../../category/Gear.html">Gear</a></span> (6)
	</li>

	<li>
		<a href="../../../category/HTML5/feed">
			<img src="../../../static/rss-small.png" title="HTML5 RSS Feed" label="HTML5 RSS Feed" />
		</a>
		<span class="label label-primary"><a href="../../../category/HTML5.html">HTML5</a></span> (1)
	</li>

	<li>
		<a href="../../../category/Heroku/feed">
			<img src="../../../static/rss-small.png" title="Heroku RSS Feed" label="Heroku RSS Feed" />
		</a>
		<span class="label label-primary"><a href="../../../category/Heroku.html">Heroku</a></span> (1)
	</li>

	<li>
		<a href="../../../category/Javascript/feed">
			<img src="../../../static/rss-small.png" title="Javascript RSS Feed" label="Javascript RSS Feed" />
		</a>
		<span class="label label-primary"><a href="../../../category/Javascript.html">Javascript</a></span> (3)
	</li>

	<li>
		<a href="../../../category/Movie%20Reviews/feed">
			<img src="../../../static/rss-small.png" title="Movie Reviews RSS Feed" label="Movie Reviews RSS Feed" />
		</a>
		<span class="label label-primary"><a href="../../../category/Movie%20Reviews.html">Movie Reviews</a></span> (5)
	</li>

	<li>
		<a href="../../../category/Netflix/feed">
			<img src="../../../static/rss-small.png" title="Netflix RSS Feed" label="Netflix RSS Feed" />
		</a>
		<span class="label label-primary"><a href="../../../category/Netflix.html">Netflix</a></span> (5)
	</li>

	<li>
		<a href="../../../category/Node.js/feed">
			<img src="../../../static/rss-small.png" title="Node.js RSS Feed" label="Node.js RSS Feed" />
		</a>
		<span class="label label-primary"><a href="../../../category/Node.html">Node.js</a></span> (1)
	</li>

	<li>
		<a href="../../../category/OpenStack/feed">
			<img src="../../../static/rss-small.png" title="OpenStack RSS Feed" label="OpenStack RSS Feed" />
		</a>
		<span class="label label-primary"><a href="../../../category/OpenStack.html">OpenStack</a></span> (1)
	</li>

	<li>
		<a href="../../../category/Personal/feed">
			<img src="../../../static/rss-small.png" title="Personal RSS Feed" label="Personal RSS Feed" />
		</a>
		<span class="label label-primary"><a href="../../../category/Personal.html">Personal</a></span> (1)
	</li>

	<li>
		<a href="../../../category/Photography/feed">
			<img src="../../../static/rss-small.png" title="Photography RSS Feed" label="Photography RSS Feed" />
		</a>
		<span class="label label-primary"><a href="../../../category/Photography.html">Photography</a></span> (6)
	</li>

	<li>
		<a href="../../../category/Product%20Reviews/feed">
			<img src="../../../static/rss-small.png" title="Product Reviews RSS Feed" label="Product Reviews RSS Feed" />
		</a>
		<span class="label label-primary"><a href="../../../category/Product%20Reviews.html">Product Reviews</a></span> (1)
	</li>

	<li>
		<a href="../../../category/Programming/feed">
			<img src="../../../static/rss-small.png" title="Programming RSS Feed" label="Programming RSS Feed" />
		</a>
		<span class="label label-primary"><a href="../../../category/Programming.html">Programming</a></span> (47)
	</li>

	<li>
		<a href="../../../category/Project%20Management/feed">
			<img src="../../../static/rss-small.png" title="Project Management RSS Feed" label="Project Management RSS Feed" />
		</a>
		<span class="label label-primary"><a href="../../../category/Project%20Management.html">Project Management</a></span> (1)
	</li>

	<li>
		<a href="../../../category/Python/feed">
			<img src="../../../static/rss-small.png" title="Python RSS Feed" label="Python RSS Feed" />
		</a>
		<span class="label label-primary"><a href="../../../category/Python.html">Python</a></span> (43)
	</li>

	<li>
		<a href="../../../category/REST/feed">
			<img src="../../../static/rss-small.png" title="REST RSS Feed" label="REST RSS Feed" />
		</a>
		<span class="label label-primary"><a href="../../../category/REST.html">REST</a></span> (5)
	</li>

	<li>
		<a href="../../../category/Rackspace/feed">
			<img src="../../../static/rss-small.png" title="Rackspace RSS Feed" label="Rackspace RSS Feed" />
		</a>
		<span class="label label-primary"><a href="../../../category/Rackspace.html">Rackspace</a></span> (1)
	</li>

	<li>
		<a href="../../../category/Raspberry%20Pi/feed">
			<img src="../../../static/rss-small.png" title="Raspberry Pi RSS Feed" label="Raspberry Pi RSS Feed" />
		</a>
		<span class="label label-primary"><a href="../../../category/Raspberry%20Pi.html">Raspberry Pi</a></span> (6)
	</li>

	<li>
		<a href="../../../category/RhinoSteady/feed">
			<img src="../../../static/rss-small.png" title="RhinoSteady RSS Feed" label="RhinoSteady RSS Feed" />
		</a>
		<span class="label label-primary"><a href="../../../category/RhinoSteady.html">RhinoSteady</a></span> (6)
	</li>

	<li>
		<a href="../../../category/Robotics/feed">
			<img src="../../../static/rss-small.png" title="Robotics RSS Feed" label="Robotics RSS Feed" />
		</a>
		<span class="label label-primary"><a href="../../../category/Robotics.html">Robotics</a></span> (6)
	</li>

	<li>
		<a href="../../../category/Video/feed">
			<img src="../../../static/rss-small.png" title="Video RSS Feed" label="Video RSS Feed" />
		</a>
		<span class="label label-primary"><a href="../../../category/Video.html">Video</a></span> (4)
	</li>

	<li>
		<a href="../../../category/Windows/feed">
			<img src="../../../static/rss-small.png" title="Windows RSS Feed" label="Windows RSS Feed" />
		</a>
		<span class="label label-primary"><a href="../../../category/Windows.html">Windows</a></span> (1)
	</li>

</ul>
                    
                </div>
            </div>
            <div class="col-md-8 col-md-pull-4">
                <div id="main">
                    
                    
                    
                    
                    

<div class="post">

<p class="date"><span class="flask-moment" data-timestamp="2012-06-09T06:44:24Z" data-format="format('LL')" data-refresh="0">2012-06-09T06:44:24Z</span></p>
<h1 class="post-title"><a href="../../the-flask-mega-tutorial-part-v-user-logins.html">The Flask Mega-Tutorial, Part V: User Logins</a></h1>
<div class="posted">Posted by <span class="label label-danger"><a href="http://blog.miguelgrinberg.com/author/Miguel Grinberg">Miguel Grinberg</a></span> under <span class="label label-primary"><a href="../../../category/Programming.html">Programming</a></span>, <span class="label label-primary"><a href="../../../category/Python.html">Python</a></span>, <span class="label label-primary"><a href="../../../category/Flask.html">Flask</a></span>, <span class="label label-primary"><a href="../../../category/Authentication.html">Authentication</a></span>. </div>
<div class="social-bar">
    <table>
        <tr>
            <td><div class="social-box" style="padding-top: 8px;"><a href="https://twitter.com/share" class="twitter-share-button" data-url="http://blog.miguelgrinberg.com/post/the-flask-mega-tutorial-part-v-user-logins" data-via="miguelgrinberg" data-count="vertical">Tweet</a></div></td>
            <td><div class="social-box" style="padding-left: 6px;"><div class="fb-like" data-href="http://blog.miguelgrinberg.com/post/the-flask-mega-tutorial-part-v-user-logins" data-send="false" data-layout="box_count" data-width="450" data-show-faces="false" data-font="verdana"></div></div></td>
            <td><div class="social-box" style="padding-top: 8px;"><g:plusone href="../../the-flask-mega-tutorial-part-v-user-logins.html" size="tall"></g:plusone></div></td>
            <td><div class="social-box" style="padding-top: 8px;"><script type="IN/Share" data-url="http://blog.miguelgrinberg.com/post/the-flask-mega-tutorial-part-v-user-logins" data-counter="top"></script></div></td>
        </tr>
    </table>
</div>
<div class="post_body"><p>This is the fifth article in the series in which I document my experience writing web applications in <a href="http://python.org/">Python</a> using the <a href="http://flask.pocoo.org/">Flask</a> microframework.</p>
<p>The goal of the tutorial series is to develop a decently featured microblogging application that demonstrating total lack of originality I have decided to call <code>microblog</code>.</p>
<p><strong>NOTE</strong>: This article was revised in September 2014 to be in sync with current versions of Python and Flask.</p>
<p>Here is an index of all the articles in the series that have been published to date:</p>
<ul>
<li><a href="../../the-flask-mega-tutorial-part-i-hello-world.html">Part I: Hello, World!</a></li>
<li><a href="../../the-flask-mega-tutorial-part-ii-templates.html">Part II: Templates</a></li>
<li><a href="../../the-flask-mega-tutorial-part-iii-web-forms.html">Part III: Web Forms</a></li>
<li><a href="../../the-flask-mega-tutorial-part-iv-database.html">Part IV: Database</a></li>
<li><a href="../../the-flask-mega-tutorial-part-v-user-logins.html">Part V: User Logins</a> (this article)</li>
<li><a href="../../the-flask-mega-tutorial-part-vi-profile-page-and-avatars.html">Part VI: Profile Page And Avatars</a></li>
<li><a href="../../the-flask-mega-tutorial-part-vii-unit-testing.html">Part VII: Unit Testing</a></li>
<li><a href="../../the-flask-mega-tutorial-part-viii-followers-contacts-and-friends.html">Part VIII: Followers, Contacts And Friends</a></li>
<li><a href="../../the-flask-mega-tutorial-part-ix-pagination.html">Part IX: Pagination</a></li>
<li><a href="../../the-flask-mega-tutorial-part-x-full-text-search.html">Part X: Full Text Search</a></li>
<li><a href="../../the-flask-mega-tutorial-part-xi-email-support.html">Part XI: Email Support</a></li>
<li><a href="../../the-flask-mega-tutorial-part-xii-facelift.html">Part XII: Facelift</a></li>
<li><a href="../../the-flask-mega-tutorial-part-xiii-dates-and-times.html">Part XIII: Dates and Times</a></li>
<li><a href="../../the-flask-mega-tutorial-part-xiv-i18n-and-l10n.html">Part XIV: I18n and L10n</a></li>
<li><a href="../../the-flask-mega-tutorial-part-xv-ajax.html">Part XV: Ajax</a></li>
<li><a href="../../the-flask-mega-tutorial-part-xvi-debugging-testing-and-profiling.html">Part XVI: Debugging, Testing and Profiling</a></li>
<li><a href="../../the-flask-mega-tutorial-part-xvii-deployment-on-linux-even-on-the-raspberry-pi.html">Part XVII: Deployment on Linux (even on the Raspberry Pi!)</a></li>
<li><a href="../../the-flask-mega-tutorial-part-xviii-deployment-on-the-heroku-cloud.html">Part XVIII: Deployment on the Heroku Cloud</a></li>
</ul>
<h2>Recap</h2>
<p>In the previous chapter of the series we created our database and learned how to populate it with users and posts, but we haven't hooked up any of that into our app yet. And two chapters ago we've seen how to create web forms and left with a fully implemented login form.</p>
<p>In this article we are going to build on what we learned about web forms and databases and write our user login system. At the end of this tutorial our little application will register new users and log them in and out.</p>
<p>To follow this chapter along you need to have the <code>microblog</code> app as we left it at the end of the previous chapter. Please make sure the app is installed and running.</p>
<h2>An Update Regarding the State of OpenID</h2>
<p>It's been more than three years ago that I wrote this article. Back then OpenID seemed like a nice authentication method that was gaining a lot of traction, but in 2015 there are better alternatives, and OpenID is not as widely deployed as it used to be.</p>
<p>I do not have plans to update this tutorial in the near future, as I have written extensively about other authentication methods elsewhere. When you follow this tutorial keep in mind that Google, which was the most prominent OpenID provider in 2012, has dropped support for this protocol completely. My recommendation is to use a Yahoo account to test OpenID in this tutorial. I have a few personal projects that still use OpenID and I use Yahoo as a provider with good results.</p>
<p>As far as real-world authentication, I do not think it is a good idea to use OpenID, given the lack of support. I have a few resources for you that can help you create a more modern authentication experience:</p>
<ul>
<li>My <a href="http://flaskbook.com/">Flask book</a> covers a traditional username and password implementation, complete with user registration, password reminders and resets.</li>
<li>My <a href="../../oauth-authentication-with-flask.html">OAuth Authentication with Flask</a> blog article describes in detail how to implement OAuth authentication, which has much wider support than OpenID. With this method you can implement "Login with Facebook" type functionality. The article demonstrates how to login with Facebook and Twitter. Others, such as Google, LinkedIn, etc. can be implemented easily with the same technique.</li>
</ul>
<h2>Configuration</h2>
<p>As in previous chapters, we start by configuring the Flask extensions that we will use. For the login system we will use two extensions, Flask-Login and Flask-OpenID. Flask-Login will handle our users logged in state, while Flask-OpenID will provide authentication. These extensions are configured as follows (file <code>app/__init__.py</code>):</p>
<pre><code>import os
from flask.ext.login import LoginManager
from flask.ext.openid import OpenID
from config import basedir

lm = LoginManager()
lm.init_app(app)
oid = OpenID(app, os.path.join(basedir, 'tmp'))
</code></pre>
<p>The Flask-OpenID extension requires a path to a temp folder where files can be stored. For this we provide the location of our <code>tmp</code> folder.</p>
<h2>Python 3 Compatiblity</h2>
<p>Unfortunately version 1.2.1 of Flask-OpenID (the current official version) does not work well with Python 3. Check what version you have by running the following command:</p>
<pre><code>$ flask/bin/pip freeze
</code></pre>
<p>If you have a version newer than 1.2.1 then the problem is likely resolved, but if you have 1.2.1 and are following this tutorial on Python 3 then you have to install the development version from GitHub:</p>
<pre><code>$ flask/bin/pip uninstall flask-openid
$ flask/bin/pip install git+git://github.com/mitsuhiko/flask-openid.git
</code></pre>
<p>Note that you need to have <code>git</code> installed for this to work.</p>
<h2>Revisiting our User model</h2>
<p>The Flask-Login extension expects certain methods to be implemented in our <code>User</code> class. Outside of these methods there are no requirements for how the class has to be implemented.</p>
<p>Below is our Flask-Login friendly <code>User</code> class (file <code>app/models.py</code>):</p>
<pre><code>class User(db.Model):
    id = db.Column(db.Integer, primary_key=True)
    nickname = db.Column(db.String(64), index=True, unique=True)
    email = db.Column(db.String(120), index=True, unique=True)
    posts = db.relationship('Post', backref='author', lazy='dynamic')

    def is_authenticated(self):
        return True

    def is_active(self):
        return True

    def is_anonymous(self):
        return False

    def get_id(self):
        try:
            return unicode(self.id)  # python 2
        except NameError:
            return str(self.id)  # python 3

    def __repr__(self):
        return '&lt;User %r&gt;' % (self.nickname)
</code></pre>
<p>The <code>is_authenticated</code> method has a misleading name. In general this method should just return <code>True</code> unless the object represents a user that should not be allowed to authenticate for some reason.</p>
<p>The <code>is_active</code> method should return True for users unless they are inactive, for example because they have been banned.</p>
<p>The <code>is_anonymous</code> method should return True only for fake users that are not supposed to log in to the system.</p>
<p>Finally, the <code>get_id</code> method should return a unique identifier for the user, in unicode format. We use the unique id generated by the database layer for this. Note that due to the differences in unicode handling between Python 2 and 3 we have to provide two alternative versions of this method.</p>
<h2>User loader callback</h2>
<p>Now we are ready to start implementing the login system using the Flask-Login and Flask-OpenID extensions.</p>
<p>First, we have to write a function that loads a user from the database. This function will be used by Flask-Login (file <code>app/views.py</code>):</p>
<pre><code>@lm.user_loader
def load_user(id):
    return User.query.get(int(id))
</code></pre>
<p>Note how this function is registered with Flask-Login through the <code>lm.user_loader</code> decorator. Also remember that user ids in Flask-Login are always unicode strings, so a conversion to an integer is necessary before we can send the id to Flask-SQLAlchemy.</p>
<h2>The login view function</h2>
<p>Next let's update our login view function (file <code>app/views.py</code>):</p>
<pre><code>from flask import render_template, flash, redirect, session, url_for, request, g
from flask.ext.login import login_user, logout_user, current_user, login_required
from app import app, db, lm, oid
from .forms import LoginForm
from .models import User

@app.route('/login', methods=['GET', 'POST'])
@oid.loginhandler
def login():
    if g.user is not None and g.user.is_authenticated():
        return redirect(url_for('index'))
    form = LoginForm()
    if form.validate_on_submit():
        session['remember_me'] = form.remember_me.data
        return oid.try_login(form.openid.data, ask_for=['nickname', 'email'])
    return render_template('login.html', 
                           title='Sign In',
                           form=form,
                           providers=app.config['OPENID_PROVIDERS'])
</code></pre>
<p>Notice we have imported several new modules, some of which we will use later.</p>
<p>The changes from our previous version are very small. We have added a new decorator to our view function. The <code>oid.loginhandler</code> tells Flask-OpenID that this is our login view function. </p>
<p>At the top of the function body we check if <code>g.user</code> is set to an authenticated user, and in that case we redirect to the index page. The idea here is that if there is a logged in user already we will not do a second login on top.</p>
<p>The <code>g</code> global is setup by Flask as a place to store and share data during the life of a request. As I'm sure you guessed by now, we will be storing the logged in user here.</p>
<p>The <code>url_for</code> function that we used in the <code>redirect</code> call is defined by Flask as a clean way to obtain the URL for a given view function. If you want to redirect to the index page you may very well use <code>redirect('/index')</code>, but there are very <a href="http://flask.pocoo.org/docs/quickstart/#url-building">good reasons</a> to let Flask build URLs for you.</p>
<p>The code that runs when we get a data back from the login form is also new. Here we do two things. First we store the value of the <code>remember_me</code> boolean in the flask <em>session</em>, not to be confused with the <code>db.session</code> from Flask-SQLAlchemy. We've seen that the <code>flask.g</code> object stores and shares data though the life of a request. The <code>flask.session</code> provides a much more complex service along those lines. Once data is stored in the session object it will be available during that request and any future requests <em>made by the same client</em>. Data remains in the session until explicitly removed. To be able to do this, Flask keeps a different session container for each client of our application.</p>
<p>The <code>oid.try_login</code> call in the following line is the call that triggers the user authentication through Flask-OpenID. The function takes two arguments, the <code>openid</code> given by the user in the web form and a list of data items that we want from the OpenID provider. Since we defined our User class to include <code>nickname</code> and <code>email</code>, those are the items we are going to ask for.</p>
<p>The OpenID authentication happens asynchronously. Flask-OpenID will call a function that is registered with the <code>oid.after_login</code> decorator if the authentication is successful. If the authentication fails the user will be taken back to the login page.</p>
<h2>The Flask-OpenID login callback</h2>
<p>Here is our implementation of the <code>after_login</code> function (file <code>app/views.py</code>):</p>
<pre><code>@oid.after_login
def after_login(resp):
    if resp.email is None or resp.email == "":
        flash('Invalid login. Please try again.')
        return redirect(url_for('login'))
    user = User.query.filter_by(email=resp.email).first()
    if user is None:
        nickname = resp.nickname
        if nickname is None or nickname == "":
            nickname = resp.email.split('@')[0]
        user = User(nickname=nickname, email=resp.email)
        db.session.add(user)
        db.session.commit()
    remember_me = False
    if 'remember_me' in session:
        remember_me = session['remember_me']
        session.pop('remember_me', None)
    login_user(user, remember = remember_me)
    return redirect(request.args.get('next') or url_for('index'))
</code></pre>
<p>The <code>resp</code> argument passed to the <code>after_login</code> function contains information returned by the OpenID provider.</p>
<p>The first <code>if</code> statement is just for validation. We require a valid email, so if an email was not provided we cannot log the user in.</p>
<p>Next, we search our database for the email provided. If the email is not found we consider this a new user, so we add a new user to our database, pretty much as we have learned in the previous chapter. Note that we handle the case of a missing <code>nickname</code>, since some OpenID providers may not have that information.</p>
<p>After that we load the <code>remember_me</code> value from the Flask session, this is the boolean that we stored in the login view function, if it is available.</p>
<p>Then we call Flask-Login's <code>login_user</code> function, to register this is a valid login.</p>
<p>Finally, in the last line we redirect to the <em>next</em> page, or the index page if a next page was not provided in the request.</p>
<p>The concept of the next page is simple. Let's say you navigate to a page that requires you to be logged in, but you aren't just yet. In Flask-Login you can protect views against non logged in users by adding the <code>login_required</code> decorator. If the user tries to access one of the affected URLs then it will be redirected to the login page automatically. Flask-Login will store the original URL as the <code>next</code> page, and it is up to us to return the user to this page once the login process completed.</p>
<p>For this to work Flask-Login needs to know what view logs users in. We can configure this in the app's module initializer (file <code>app/__init__.py</code>):</p>
<pre><code>lm = LoginManager()
lm.init_app(app)
lm.login_view = 'login'
</code></pre>
<h2>The g.user global</h2>
<p>If you were paying attention, you will remember that in the login view function we check <code>g.user</code> to determine if a user is already logged in. To implement this we will use the <code>before_request</code> event from Flask. Any functions that are decorated with <code>before_request</code> will run before the view function each time a request is received. So this is the right place to setup our <code>g.user</code> variable (file <code>app/views.py</code>):</p>
<pre><code>@app.before_request
def before_request():
    g.user = current_user
</code></pre>
<p>This is all it takes. The <code>current_user</code> global is set by Flask-Login, so we just put a copy in the <code>g</code> object to have better access to it. With this, all requests will have access to the logged in user, even inside templates.</p>
<h2>The index view</h2>
<p>In a previous chapter we left our <code>index</code> view function using fake objects, because at the time we did not have users or posts in our system. Well, we have users now, so let's hook that up:</p>
<pre><code>@app.route('/')
@app.route('/index')
@login_required
def index():
    user = g.user
    posts = [
        { 
            'author': {'nickname': 'John'}, 
            'body': 'Beautiful day in Portland!' 
        },
        { 
            'author': {'nickname': 'Susan'}, 
            'body': 'The Avengers movie was so cool!' 
        }
    ]
    return render_template('index.html',
                           title='Home',
                           user=user,
                           posts=posts)
</code></pre>
<p>There are only two changes to this function. First, we have added the <code>login_required</code> decorator. This will ensure that this page is only seen by logged in users.</p>
<p>The other change is that we pass <code>g.user</code> down to the template, instead of the fake object we used in the past.</p>
<p>This is a good time to run the application.</p>
<p>When you navigate to <code>http://localhost:5000</code> you will instead get the login page. Keep in mind that to login with OpenID you have to use the OpenID URL from your provider. You can use one of the OpenID provider links below the URL text field to generate the correct URL for you.</p>
<p>As part of the login process you will be redirected to your provider's web site, where you will authenticate and authorize the sharing of some information with our application (just the email and nickname that we requested, no passwords or other personal information will be exposed).</p>
<p>Once the login is complete you will be taken to the index page, this time as a logged in user.</p>
<p>Feel free to try the <code>remember_me</code> checkbox. With this option enabled you can close and reopen your web browser and will continue to be logged in.</p>
<h2>Logging out</h2>
<p>We have implemented the log in, now it's time to add the log out.</p>
<p>The view function for logging out is extremely simple (file <code>app/views.py</code>):</p>
<pre><code>@app.route('/logout')
def logout():
    logout_user()
    return redirect(url_for('index'))
</code></pre>
<p>But we are also missing a link to logout in the template. We are going to put this link in the top navigation bar which is in the base layout (file <code>app/templates/base.html</code>):</p>
<pre><code>&lt;html&gt;
  &lt;head&gt;
    {% if title %}
    &lt;title&gt;{{ title }} - microblog&lt;/title&gt;
    {% else %}
    &lt;title&gt;microblog&lt;/title&gt;
    {% endif %}
  &lt;/head&gt;
  &lt;body&gt;
    &lt;div&gt;Microblog:
        &lt;a href="{{ url_for('index') }}"&gt;Home&lt;/a&gt;
        {% if g.user.is_authenticated() %}
        | &lt;a href="{{ url_for('logout') }}"&gt;Logout&lt;/a&gt;
        {% endif %}
    &lt;/div&gt;
    &lt;hr&gt;
    {% with messages = get_flashed_messages() %}
    {% if messages %}
    &lt;ul&gt;
    {% for message in messages %}
        &lt;li&gt;{{ message }} &lt;/li&gt;
    {% endfor %}
    &lt;/ul&gt;
    {% endif %}
    {% endwith %}
    {% block content %}{% endblock %}
  &lt;/body&gt;
&lt;/html&gt;
</code></pre>
<p>Note how easy it is to do this. We just needed to check if we have a valid user set in <code>g.user</code> and if we do we just add the logout link. We have also used the opportunity to use <code>url_for</code> in our template.</p>
<h2>Final words</h2>
<p>We now have a fully functioning user login system. In the next chapter we will be creating the user profile page and will be displaying user avatars on them.</p>
<p>In the meantime, here is the updated application code including all the changes in this article:</p>
<p>Download <a href="https://codeload.github.com/miguelgrinberg/microblog/zip/version-0.5">microblog-0.5.zip</a>.</p>
<p>See you next time!</p>
<p>Miguel</p></div>
<div class="social-bar">
    <table>
        <tr>
            <td><div class="social-box" style="padding-top: 8px;"><a href="https://twitter.com/share" class="twitter-share-button" data-url="http://blog.miguelgrinberg.com/post/the-flask-mega-tutorial-part-v-user-logins" data-via="miguelgrinberg" data-count="vertical">Tweet</a></div></td>
            <td><div class="social-box" style="padding-left: 6px;"><div class="fb-like" data-href="http://blog.miguelgrinberg.com/post/the-flask-mega-tutorial-part-v-user-logins" data-send="false" data-layout="box_count" data-width="450" data-show-faces="false" data-font="verdana"></div></div></td>
            <td><div class="social-box" style="padding-top: 8px;"><g:plusone href="../../the-flask-mega-tutorial-part-v-user-logins.html" size="tall"></g:plusone></div></td>
            <td><div class="social-box" style="padding-top: 8px;"><script type="IN/Share" data-url="http://blog.miguelgrinberg.com/post/the-flask-mega-tutorial-part-v-user-logins" data-counter="top"></script></div></td>
        </tr>
    </table>
</div>


<h4 style="text-align: right"><a name="comments"></a>217 comments</h4>


<div class="comment">
    <ul>
        
        <li>
            <div class="comment-thumbnail"><img src="../../../../gravatar.com/avatar/ec034b9a35830fd7c7bb3a9d85bde0c9ce2c.png?s=60&amp;d=identicon" /></div>
            <div class="comment-body">
                <p>
                    <span class="label label-default">#101</span> <span class="label label-primary">Cloom</span> said
                    <span class="flask-moment" data-timestamp="2014-01-09T16:35:13Z" data-format="fromNow(0)" data-refresh="0">2014-01-09T16:35:13Z</span>
                </p>
                <div style="overflow: auto;">
                    <p style="white-space: pre-wrap;">Thanks for an awesome tutorial! I found it while looking to learn about flask with a view to comparing it against node.js. Still working though it, but I certainly haven&#39;t found any node.js tutorials that match the level of this example.

One note: I got the following error when attempting to run run.py:
  File &#34;./run.py&#34;, line 2, in &lt;module&gt;
    from app import app
  File &#34;/home/colmmchugh/python/microblog/app/__init__.py&#34;, line 6, in &lt;module&gt;
    from config import basedir
ImportError: cannot import name basedir

To fix this (for me), I made the following changes:
1) Add this to config.py
BASEDIR = basedir
2) Access BASEDIR via app.config in __init__.py:
oid = OpenID(app, os.path.join(app.config[&#39;BASEDIR&#39;], &#39;tmp))

(&amp; remove the &#39;from config import basedir&#39; statement from __init__.py)

I realize this is almost two years later, so a lot has probably changed but in case anyone else has a similar issue. And thanks again!</p>
                </div>
            </div>
        </li>
        
        <li>
            <div class="comment-thumbnail"><img src="../../../../gravatar.com/avatar/729e26a2a2c7ff24a71958d4aa4e5f35ce2c.jpeg?s=60&amp;d=identicon" /></div>
            <div class="comment-body">
                <p>
                    <span class="label label-default">#102</span> <span class="label label-danger">Miguel Grinberg</span> said
                    <span class="flask-moment" data-timestamp="2014-01-09T16:41:59Z" data-format="fromNow(0)" data-refresh="0">2014-01-09T16:41:59Z</span>
                </p>
                <div style="overflow: auto;">
                    <p style="white-space: pre-wrap;">@Cloom: your config.py should have the following at the top:

import os
basedir = os.path.abspath(os.path.dirname(__file__))

This is what makes basedir available for import in other modules.</p>
                </div>
            </div>
        </li>
        
        <li>
            <div class="comment-thumbnail"><img src="../../../../gravatar.com/avatar/7a2aac003b0d4b9a2ce2db73f40939d9ce2c.png?s=60&amp;d=identicon" /></div>
            <div class="comment-body">
                <p>
                    <span class="label label-default">#103</span> <span class="label label-primary">Travis</span> said
                    <span class="flask-moment" data-timestamp="2014-01-24T22:15:16Z" data-format="fromNow(0)" data-refresh="0">2014-01-24T22:15:16Z</span>
                </p>
                <div style="overflow: auto;">
                    <p style="white-space: pre-wrap;">I seem to be having some issues with the call to 
return oid.try_login(form.openid.data, ask_for = [&#39;nickname&#39;, &#39;email&#39;])

It is throwing a TypeError: &#39;NoneType&#39; object is not iterable. At first I thought maybe form.openid was actually NULL, but I used flash to output what was being passed to try_login() and it was what I was expecting.</p>
                </div>
            </div>
        </li>
        
        <li>
            <div class="comment-thumbnail"><img src="../../../../gravatar.com/avatar/729e26a2a2c7ff24a71958d4aa4e5f35ce2c.jpeg?s=60&amp;d=identicon" /></div>
            <div class="comment-body">
                <p>
                    <span class="label label-default">#104</span> <span class="label label-danger">Miguel Grinberg</span> said
                    <span class="flask-moment" data-timestamp="2014-01-25T20:32:23Z" data-format="fromNow(0)" data-refresh="0">2014-01-25T20:32:23Z</span>
                </p>
                <div style="overflow: auto;">
                    <p style="white-space: pre-wrap;">@Travis: I need to see the complete stack trace of the error.</p>
                </div>
            </div>
        </li>
        
        <li>
            <div class="comment-thumbnail"><img src="../../../../gravatar.com/avatar/7a2aac003b0d4b9a2ce2db73f40939d9ce2c.png?s=60&amp;d=identicon" /></div>
            <div class="comment-body">
                <p>
                    <span class="label label-default">#105</span> <span class="label label-primary">Travis</span> said
                    <span class="flask-moment" data-timestamp="2014-01-25T23:49:11Z" data-format="fromNow(0)" data-refresh="0">2014-01-25T23:49:11Z</span>
                </p>
                <div style="overflow: auto;">
                    <p style="white-space: pre-wrap;">The stack trace is as follows:
Traceback (most recent call last):
  File &#34;/Users/Tr_Heath20/microblog/flask/lib/python2.7/site-packages/flask/app.py&#34;, line 1701, in __call__
    return self.wsgi_app(environ, start_response)
  File &#34;/Users/Tr_Heath20/microblog/flask/lib/python2.7/site-packages/flask/app.py&#34;, line 1689, in wsgi_app
    response = self.make_response(self.handle_exception(e))
  File &#34;/Users/Tr_Heath20/microblog/flask/lib/python2.7/site-packages/flask/app.py&#34;, line 1687, in wsgi_app
    response = self.full_dispatch_request()
  File &#34;/Users/Tr_Heath20/microblog/flask/lib/python2.7/site-packages/flask/app.py&#34;, line 1360, in full_dispatch_request
    rv = self.handle_user_exception(e)
  File &#34;/Users/Tr_Heath20/microblog/flask/lib/python2.7/site-packages/flask/app.py&#34;, line 1358, in full_dispatch_request
    rv = self.dispatch_request()
  File &#34;/Users/Tr_Heath20/microblog/flask/lib/python2.7/site-packages/flask/app.py&#34;, line 1344, in dispatch_request
    return self.view_functions[rule.endpoint](**req.view_args)
  File &#34;/Users/Tr_Heath20/microblog/flask/lib/python2.7/site-packages/flask_openid.py&#34;, line 480, in decorated
    return f(*args, **kwargs)
  File &#34;/Users/Tr_Heath20/microblog/app/views.py&#34;, line 51, in login
    return oid.try_login(form.openid.data, ask_for = [&#39;nickname&#39;, &#39;email&#39;])
  File &#34;/Users/Tr_Heath20/microblog/flask/lib/python2.7/site-packages/flask_openid.py&#34;, line 518, in try_login
    for key in ask_for_optional:
TypeError: &#39;NoneType&#39; object is not iterable</p>
                </div>
            </div>
        </li>
        
        <li>
            <div class="comment-thumbnail"><img src="../../../../gravatar.com/avatar/cd3f53dda1160a0387c621b3beddaeb2ce2c.jpeg?s=60&amp;d=identicon" /></div>
            <div class="comment-body">
                <p>
                    <span class="label label-default">#106</span> <span class="label label-primary">Sexy Naruto</span> said
                    <span class="flask-moment" data-timestamp="2014-01-26T20:06:30Z" data-format="fromNow(0)" data-refresh="0">2014-01-26T20:06:30Z</span>
                </p>
                <div style="overflow: auto;">
                    <p style="white-space: pre-wrap;">@Travis 
there is bug in OPENID extension , in try_login function...
except ask_for there is also ask_for_optional parameter (which should be optional lol but obviously it doesnt work if u doesnt add to it atleast empty list)
so to make it work u must do 
return oid.try_login(form.openid.data, ask_for = [&#39;nickname&#39;, &#39;email&#39;],ask_for_optional=[])
here is openid&#39;s doc http://packages.python.org/Flask-OpenID/

and here is traceback:
Traceback (most recent call last):
  File &#34;/home/gaucan/webdev/microblog2/flask/lib/python2.7/site-packages/flask/app.py&#34;, line 1836, in __call__
    return self.wsgi_app(environ, start_response)
  File &#34;/home/gaucan/webdev/microblog2/flask/lib/python2.7/site-packages/flask/app.py&#34;, line 1820, in wsgi_app
    response = self.make_response(self.handle_exception(e))
  File &#34;/home/gaucan/webdev/microblog2/flask/lib/python2.7/site-packages/flask/app.py&#34;, line 1403, in handle_exception
    reraise(exc_type, exc_value, tb)
  File &#34;/home/gaucan/webdev/microblog2/flask/lib/python2.7/site-packages/flask/app.py&#34;, line 1817, in wsgi_app
    response = self.full_dispatch_request()
  File &#34;/home/gaucan/webdev/microblog2/flask/lib/python2.7/site-packages/flask/app.py&#34;, line 1477, in full_dispatch_request
    rv = self.handle_user_exception(e)
  File &#34;/home/gaucan/webdev/microblog2/flask/lib/python2.7/site-packages/flask/app.py&#34;, line 1381, in handle_user_exception
    reraise(exc_type, exc_value, tb)
  File &#34;/home/gaucan/webdev/microblog2/flask/lib/python2.7/site-packages/flask/app.py&#34;, line 1475, in full_dispatch_request
    rv = self.dispatch_request()
  File &#34;/home/gaucan/webdev/microblog2/flask/lib/python2.7/site-packages/flask/app.py&#34;, line 1461, in dispatch_request
    return self.view_functions[rule.endpoint](**req.view_args)
  File &#34;/home/gaucan/webdev/microblog2/flask/lib/python2.7/site-packages/flask_openid.py&#34;, line 480, in decorated
    return f(*args, **kwargs)
  File &#34;/home/gaucan/webdev/microblog2/app/views.py&#34;, line 43, in login
    return oid.try_login(form.openid.data,ask_for=[&#39;nickname&#39;,&#39;email&#39;])
  File &#34;/home/gaucan/webdev/microblog2/flask/lib/python2.7/site-packages/flask_openid.py&#34;, line 518, in try_login
    for key in ask_for_optional:
TypeError: &#39;NoneType&#39; object is not iterable</p>
                </div>
            </div>
        </li>
        
        <li>
            <div class="comment-thumbnail"><img src="../../../../gravatar.com/avatar/7a2aac003b0d4b9a2ce2db73f40939d9ce2c.png?s=60&amp;d=identicon" /></div>
            <div class="comment-body">
                <p>
                    <span class="label label-default">#107</span> <span class="label label-primary">Travis</span> said
                    <span class="flask-moment" data-timestamp="2014-01-29T04:23:38Z" data-format="fromNow(0)" data-refresh="0">2014-01-29T04:23:38Z</span>
                </p>
                <div style="overflow: auto;">
                    <p style="white-space: pre-wrap;">Thanks! That fixed that problem. I&#39;m getting a valid id_res from the providers, however is_authenticated() never is set to True, it always False.</p>
                </div>
            </div>
        </li>
        
        <li>
            <div class="comment-thumbnail"><img src="../../../../gravatar.com/avatar/7a2aac003b0d4b9a2ce2db73f40939d9ce2c.png?s=60&amp;d=identicon" /></div>
            <div class="comment-body">
                <p>
                    <span class="label label-default">#108</span> <span class="label label-primary">Travis</span> said
                    <span class="flask-moment" data-timestamp="2014-01-29T05:18:03Z" data-format="fromNow(0)" data-refresh="0">2014-01-29T05:18:03Z</span>
                </p>
                <div style="overflow: auto;">
                    <p style="white-space: pre-wrap;">After using a series of Flash() statements I was able to debug it myself. In the views.py file, there is a check to see if resp.email is None or if it is blank, it Flash()&#39;s a error and then returns to the login page. Well, somehow, that return statement was being interpreted as OUTSIDE of that IF. What happened is it would always return to Login without ever running the login_user function.

To fix it I simply removed the whitespace before the line and redid the whitespace. </p>
                </div>
            </div>
        </li>
        
        <li>
            <div class="comment-thumbnail"><img src="../../../../gravatar.com/avatar/966e35776138bdc3f502586c311bba8bce2c.png?s=60&amp;d=identicon" /></div>
            <div class="comment-body">
                <p>
                    <span class="label label-default">#109</span> <span class="label label-primary">jason</span> said
                    <span class="flask-moment" data-timestamp="2014-02-08T23:37:23Z" data-format="fromNow(0)" data-refresh="0">2014-02-08T23:37:23Z</span>
                </p>
                <div style="overflow: auto;">
                    <p style="white-space: pre-wrap;">Hello Miguel,

When I try to log in I get an error. I choose an OpenID provider, it takes me to their site and then when I enter my username and password instead of being redirected back to the index I get the below error.

app.py&#34;
return self.wsgi_app(environ, start_response)
response = self.make_response(self.handle_exception(e))
response = self.full_dispatch_request()
rv = self.handle_user_exception(e)
rv = self.dispatch_request()
return self.view_functions[rule.endpoint](**req.view_args)

flask_openid.py&#34;, line 487, in decorated
openid_response, self.extension_responses))

TypeError: &#39;NoneType&#39; object is not callable

Any ideas? I have spent hours today troubleshooting this and I am kind of stuck.

Thanks.</p>
                </div>
            </div>
        </li>
        
        <li>
            <div class="comment-thumbnail"><img src="../../../../gravatar.com/avatar/729e26a2a2c7ff24a71958d4aa4e5f35ce2c.jpeg?s=60&amp;d=identicon" /></div>
            <div class="comment-body">
                <p>
                    <span class="label label-default">#110</span> <span class="label label-danger">Miguel Grinberg</span> said
                    <span class="flask-moment" data-timestamp="2014-02-09T00:18:38Z" data-format="fromNow(0)" data-refresh="0">2014-02-09T00:18:38Z</span>
                </p>
                <div style="overflow: auto;">
                    <p style="white-space: pre-wrap;">@jason: based on your error it appears you have not defined an &#34;after_login&#34; handler. This is the function that uses the &#34;oid.after_login&#34; decorator from Flask-OpenID.</p>
                </div>
            </div>
        </li>
        
        <li>
            <div class="comment-thumbnail"><img src="../../../../gravatar.com/avatar/9e1ac9d35d5d68c0a853e81040cbabe6ce2c.png?s=60&amp;d=identicon" /></div>
            <div class="comment-body">
                <p>
                    <span class="label label-default">#111</span> <span class="label label-primary">naren</span> said
                    <span class="flask-moment" data-timestamp="2014-02-14T12:28:48Z" data-format="fromNow(0)" data-refresh="0">2014-02-14T12:28:48Z</span>
                </p>
                <div style="overflow: auto;">
                    <p style="white-space: pre-wrap;">Hi Miguel. Thanks to your posts I have been able to learn about flask with ease. I was wondering if you could next post the procedure to run a sample code in the background indefinitely. </p>
                </div>
            </div>
        </li>
        
        <li>
            <div class="comment-thumbnail"><img src="../../../../gravatar.com/avatar/6fa0439eba2eee9d0328a74cd75630d4ce2c.png?s=60&amp;d=identicon" /></div>
            <div class="comment-body">
                <p>
                    <span class="label label-default">#112</span> <span class="label label-primary">jack</span> said
                    <span class="flask-moment" data-timestamp="2014-02-24T18:36:22Z" data-format="fromNow(0)" data-refresh="0">2014-02-24T18:36:22Z</span>
                </p>
                <div style="overflow: auto;">
                    <p style="white-space: pre-wrap;">Thanx miguel. Your tutorials are very helpful.</p>
                </div>
            </div>
        </li>
        
        <li>
            <div class="comment-thumbnail"><img src="../../../../gravatar.com/avatar/86129ed5948199fe636f3aca2a674d78ce2c.png?s=60&amp;d=identicon" /></div>
            <div class="comment-body">
                <p>
                    <span class="label label-default">#113</span> <span class="label label-primary">Dan</span> said
                    <span class="flask-moment" data-timestamp="2014-03-03T10:46:39Z" data-format="fromNow(0)" data-refresh="0">2014-03-03T10:46:39Z</span>
                </p>
                <div style="overflow: auto;">
                    <p style="white-space: pre-wrap;">Hi Miguel
I’m getting a bit confused by alternative approaches to the user login approach.
For the remember_me functionality:
Your method seems to be introducing a new attribute to the flask.session object, ie. Session[‘remember_me’]=form.remember_me.data
The Flask-login docs and another tutorial I’ve seen uses the remember_me argument of the login_user function, ie.
login_user(user, remember = form.remember_me.data)
Also with recording the user for the session:
You used the before_request() | g.user=current_user approach but I have also seen tutorials use 
session[&#39;signed&#39;] = True
session[&#39;username&#39;]= user.username statements within the login function.

There seems to be a mix of approach, sometimes using the session object and introducing new attributes to store your user data, and sometimes using the flask-login functions to do it all for you.
Do you have any comment on the two approaches?
Dan
</p>
                </div>
            </div>
        </li>
        
        <li>
            <div class="comment-thumbnail"><img src="../../../../gravatar.com/avatar/729e26a2a2c7ff24a71958d4aa4e5f35ce2c.jpeg?s=60&amp;d=identicon" /></div>
            <div class="comment-body">
                <p>
                    <span class="label label-default">#114</span> <span class="label label-danger">Miguel Grinberg</span> said
                    <span class="flask-moment" data-timestamp="2014-03-03T15:32:01Z" data-format="fromNow(0)" data-refresh="0">2014-03-03T15:32:01Z</span>
                </p>
                <div style="overflow: auto;">
                    <p style="white-space: pre-wrap;">@Dan: putting the &#34;remember_me&#34; in the session is necessary in my case because the OpenID authentication is asynchronous. At the time I get the form POST request I have to save this value somewhere, so that I can pass it to login_user() later when OpenID invokes the callback route. If you use regular username/password where you can validate the credentials right in the POST request then I would pass it directly to login_user() as you saw elsewhere.

The g.user bit is really not necessary, you can really access current_user directly, and in fact that is how I&#39;m doing it these days.

I&#39;m not sure what the signed/username things written to the session are, but in any case, with almost everything in Flask you have the freedom to do things your way, so this is likely a personal preference of the developer who wrote that other tutorial. You should look at that solution, my solution, and any others that you find and then use that to develop the solution that works best for you. That is the Flask way!</p>
                </div>
            </div>
        </li>
        
        <li>
            <div class="comment-thumbnail"><img src="../../../../gravatar.com/avatar/86129ed5948199fe636f3aca2a674d78ce2c.png?s=60&amp;d=identicon" /></div>
            <div class="comment-body">
                <p>
                    <span class="label label-default">#115</span> <span class="label label-primary">Dan</span> said
                    <span class="flask-moment" data-timestamp="2014-03-07T13:23:02Z" data-format="fromNow(0)" data-refresh="0">2014-03-07T13:23:02Z</span>
                </p>
                <div style="overflow: auto;">
                    <p style="white-space: pre-wrap;">Thanks Miguel
Yes, I&#39;ve moved away from the openID solution so that makes a bit more sense now.
Thanks for clarifying,
Dan</p>
                </div>
            </div>
        </li>
        
        <li>
            <div class="comment-thumbnail"><img src="../../../../gravatar.com/avatar/f618a061acedf8acc700ffce3a56ce7ece2c.png?s=60&amp;d=identicon" /></div>
            <div class="comment-body">
                <p>
                    <span class="label label-default">#116</span> <span class="label label-primary">Elon</span> said
                    <span class="flask-moment" data-timestamp="2014-03-10T02:50:49Z" data-format="fromNow(0)" data-refresh="0">2014-03-10T02:50:49Z</span>
                </p>
                <div style="overflow: auto;">
                    <p style="white-space: pre-wrap;">Hi Miguel, I&#39;m following along with this quite nicely without many problems; thanks for being clear and instructive. Can you tell me: is it important if the order of your view definitions matters? i.e. could I have def index() be at the very bottom if I wanted, and would that cause any unintended problems?</p>
                </div>
            </div>
        </li>
        
        <li>
            <div class="comment-thumbnail"><img src="../../../../gravatar.com/avatar/729e26a2a2c7ff24a71958d4aa4e5f35ce2c.jpeg?s=60&amp;d=identicon" /></div>
            <div class="comment-body">
                <p>
                    <span class="label label-default">#117</span> <span class="label label-danger">Miguel Grinberg</span> said
                    <span class="flask-moment" data-timestamp="2014-03-10T03:27:18Z" data-format="fromNow(0)" data-refresh="0">2014-03-10T03:27:18Z</span>
                </p>
                <div style="overflow: auto;">
                    <p style="white-space: pre-wrap;">@Elon: the order in which you define the view functions does not matter at all. In fact you can also define your view functions in multiple modules and nothing changes still.</p>
                </div>
            </div>
        </li>
        
        <li>
            <div class="comment-thumbnail"><img src="../../../../gravatar.com/avatar/f95521131343273eab6a7813dee0908bce2c.jpeg?s=60&amp;d=identicon" /></div>
            <div class="comment-body">
                <p>
                    <span class="label label-default">#118</span> <span class="label label-primary">Sam</span> said
                    <span class="flask-moment" data-timestamp="2014-04-07T17:32:27Z" data-format="fromNow(0)" data-refresh="0">2014-04-07T17:32:27Z</span>
                </p>
                <div style="overflow: auto;">
                    <p style="white-space: pre-wrap;">Naive question about openauth:  On the login page, I can specify any openauth provider.  What&#39;s to prevent me from creating a fake openauth provider that returns someone elses email in &#34;resp&#34; as a way to hack into someones account?  When you retrieve the user from the database, don&#39;t you have to check that the domain of the email address returned matches the openauth domain?  Or is that built in?

Great articles, learning a  lot!</p>
                </div>
            </div>
        </li>
        
        <li>
            <div class="comment-thumbnail"><img src="../../../../gravatar.com/avatar/04d4dce70309167c7c01987890786286ce2c.png?s=60&amp;d=identicon" /></div>
            <div class="comment-body">
                <p>
                    <span class="label label-default">#119</span> <span class="label label-primary">anand</span> said
                    <span class="flask-moment" data-timestamp="2014-04-08T00:25:57Z" data-format="fromNow(0)" data-refresh="0">2014-04-08T00:25:57Z</span>
                </p>
                <div style="overflow: auto;">
                    <p style="white-space: pre-wrap;">I am having issues while importing the extension
I get the following error:

Traceback (most recent call last):
  File &#34;run.py&#34;, line 2, in &lt;module&gt;
    from app import app
  File &#34;/Users/anandsharma/Documents/Dev/python/flasktut/app/__init__.py&#34;, line 14, in &lt;module&gt;
    from app import views, models, lm
  File &#34;/Users/anandsharma/Documents/Dev/python/flasktut/app/views.py&#34;, line 3, in &lt;module&gt;
    from app import app, db, lm, oid
ImportError: cannot import name lm

Can anyone help? I was able to run everything until this 
</p>
                </div>
            </div>
        </li>
        
        <li>
            <div class="comment-thumbnail"><img src="../../../../gravatar.com/avatar/729e26a2a2c7ff24a71958d4aa4e5f35ce2c.jpeg?s=60&amp;d=identicon" /></div>
            <div class="comment-body">
                <p>
                    <span class="label label-default">#120</span> <span class="label label-danger">Miguel Grinberg</span> said
                    <span class="flask-moment" data-timestamp="2014-04-08T04:37:58Z" data-format="fromNow(0)" data-refresh="0">2014-04-08T04:37:58Z</span>
                </p>
                <div style="overflow: auto;">
                    <p style="white-space: pre-wrap;">@Sam: After you enter the OpenID the application redirects to a page on the provider&#39;s web site where the user must authenticate. If you can&#39;t login with the provider you will not be given access to the application.</p>
                </div>
            </div>
        </li>
        
        <li>
            <div class="comment-thumbnail"><img src="../../../../gravatar.com/avatar/729e26a2a2c7ff24a71958d4aa4e5f35ce2c.jpeg?s=60&amp;d=identicon" /></div>
            <div class="comment-body">
                <p>
                    <span class="label label-default">#121</span> <span class="label label-danger">Miguel Grinberg</span> said
                    <span class="flask-moment" data-timestamp="2014-04-08T04:39:02Z" data-format="fromNow(0)" data-refresh="0">2014-04-08T04:39:02Z</span>
                </p>
                <div style="overflow: auto;">
                    <p style="white-space: pre-wrap;">@anand: the &#34;lm&#34; symbol is the LoginManager instance, create in app/__init__.py. Check this file, it must be missing there.</p>
                </div>
            </div>
        </li>
        
        <li>
            <div class="comment-thumbnail"><img src="../../../../gravatar.com/avatar/4889729f32f6d6c8b9cd443c16322624ce2c.jpeg?s=60&amp;d=identicon" /></div>
            <div class="comment-body">
                <p>
                    <span class="label label-default">#122</span> <span class="label label-primary">Gaurav Gupta</span> said
                    <span class="flask-moment" data-timestamp="2014-04-13T11:14:34Z" data-format="fromNow(0)" data-refresh="0">2014-04-13T11:14:34Z</span>
                </p>
                <div style="overflow: auto;">
                    <p style="white-space: pre-wrap;">Hi Miguel, while following this login tutorial, I am getting below error :

Traceback (most recent call last):
  File &#34;./run.py&#34;, line 3, in &lt;module&gt;
    from app import app
  File &#34;/Users/gagupta/gaurav/flask_learning/microblog/app/__init__.py&#34;, line 15, in &lt;module&gt;
    from app import views, models
  File &#34;/Users/gagupta/gaurav/flask_learning/microblog/app/views.py&#34;, line 3, in &lt;module&gt;
    from app import app, db, lm, oid
ImportError: cannot import name lm

I have tried checking above solution given to anand but still I am not able to find any issues in code. Can you please guide

from flask import Flask
from flask.ext.sqlalchemy import SQLAlchemy
import os
from flask.ext.login import LoginManager
from flask.ext.openid import OpenID
from config import basedir


app = Flask(__name__)
app.config.from_object(&#39;config&#39;)
db = SQLAlchemy(app)

from app import views, models

lm = LoginManager()
lm.init_app(app)
lm.login_view = &#39;login&#39;
oid = OpenID(app, os.path.join(basedir, &#39;tmp&#39;))</p>
                </div>
            </div>
        </li>
        
        <li>
            <div class="comment-thumbnail"><img src="../../../../gravatar.com/avatar/729e26a2a2c7ff24a71958d4aa4e5f35ce2c.jpeg?s=60&amp;d=identicon" /></div>
            <div class="comment-body">
                <p>
                    <span class="label label-default">#123</span> <span class="label label-danger">Miguel Grinberg</span> said
                    <span class="flask-moment" data-timestamp="2014-04-13T14:57:59Z" data-format="fromNow(0)" data-refresh="0">2014-04-13T14:57:59Z</span>
                </p>
                <div style="overflow: auto;">
                    <p style="white-space: pre-wrap;">@Gaurav: you have circular dependencies. Move the line &#34;from app import views, models&#34; in your __init__.py to the bottom (after the LoginManager and OpenID objects are created) and then you will be fine.</p>
                </div>
            </div>
        </li>
        
        <li>
            <div class="comment-thumbnail"><img src="../../../../gravatar.com/avatar/397c355e903ce6d5ed7750ba658c42f2ce2c.jpeg?s=60&amp;d=identicon" /></div>
            <div class="comment-body">
                <p>
                    <span class="label label-default">#124</span> <span class="label label-primary">Joel Clipperton</span> said
                    <span class="flask-moment" data-timestamp="2014-05-12T08:10:25Z" data-format="fromNow(0)" data-refresh="0">2014-05-12T08:10:25Z</span>
                </p>
                <div style="overflow: auto;">
                    <p style="white-space: pre-wrap;">I&#39;m not sure what&#39;s going on here.  Only the AIM and Flickr OpenID options work when trying to log in.  The others just return to the microblog login page.  </p>
                </div>
            </div>
        </li>
        
        <li>
            <div class="comment-thumbnail"><img src="../../../../gravatar.com/avatar/ca1c315f3fe2314b3bcb5be37b83c289ce2c.png?s=60&amp;d=identicon" /></div>
            <div class="comment-body">
                <p>
                    <span class="label label-default">#125</span> <span class="label label-primary">Nandhini</span> said
                    <span class="flask-moment" data-timestamp="2014-05-23T09:16:43Z" data-format="fromNow(0)" data-refresh="0">2014-05-23T09:16:43Z</span>
                </p>
                <div style="overflow: auto;">
                    <p style="white-space: pre-wrap;">Greetings again Miguel, first and foremost thanks so much for providing this resource. 
once i completed the login view,and try to execute ./run.py i get the following error:
Traceback (most recent call last):
  File &#34;./run.py&#34;, line 2, in &lt;module&gt;
    from app import app
  File &#34;/home/user/microblog/app/__init__.py&#34;, line 9, in &lt;module&gt;
    lm.init_app(app)
NameError: name &#39;app&#39; is not defined
could you please help me with this.
thanks -Nandhini</p>
                </div>
            </div>
        </li>
        
    </ul>
</div>

<div class="page">
<ul class="pager">
  <li class="previous">
    <a href="1.html#comments">&laquo;&laquo;</a>
  </li>
  <li class="previous">
    <a href="4.html#comments">&laquo;</a>
  </li>
  <li class="next">
    <a href="0.html#comments">&raquo;&raquo;</a>
  </li>
  <li class="next">
    <a href="6.html#comments">&raquo;</a>
  </li>
</ul>
</div>


</div>

                </div>
            </div>
        </div>
        <div id="footer">
            <p class="elapsed">This page was generated in None seconds.</p>
            <p>&copy; 2014 by Miguel Grinberg. All rights reserved. <a href="mailto:webmaster _at_ miguelgrinberg _dot_ com">Questions?</a></p>
        </div>
    </div>


    
    
    <script src="../../../../cdnjs.cloudflare.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
    <script src="../../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.0/js/bootstrap.min.js"></script>
	<script type="text/javascript" src="../../../../cdnjs.cloudflare.com/ajax/libs/jquery.colorbox/1.4.33/jquery.colorbox-min.js"></script>
    <script type="text/javascript" src="../../../static/prettify.js"></script>
    <script src="../../../../cdnjs.cloudflare.com/ajax/libs/moment.js/2.5.1/moment-with-langs.min.js"></script>
<script>
function flask_moment_render(elem) {
    $(elem).text(eval('moment("' + $(elem).data('timestamp') + '").' + $(elem).data('format') + ';'));
    $(elem).removeClass('flask-moment');
}
function flask_moment_render_all() {
    $('.flask-moment').each(function() {
        flask_moment_render(this);
        if ($(this).data('refresh')) {
            (function(elem, interval) { setInterval(function() { flask_moment_render(elem) }, interval); })(this, $(this).data('refresh'));
        }
    })
}
$(document).ready(function() {
    flask_moment_render_all();
});
</script>
    
    <script type="text/javascript">
      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-4777284-15']);
      _gaq.push(['_trackPageview']);

      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();
    </script>
    
    <script type="text/javascript">
        $(document).ready(function(){
            $(".gallery").colorbox({rel:".gallery",maxWidth:"95%",maxHeight:"95%",scalePhotos:true});
            // add prettyprint class to all <pre><code></code></pre> blocks
            var prettify = false;
            $("pre code").parent().each(function() {
                $(this).addClass('prettyprint');
                prettify = true;
            });
            prettyPrint();
        });
    </script>


  </body>

<!-- Mirrored from blog.miguelgrinberg.com/post/the-flask-mega-tutorial-part-v-user-logins/page/5 by HTTrack Website Copier/3.x [XR&CO'2014], Fri, 14 Aug 2015 06:14:52 GMT -->
</html>
