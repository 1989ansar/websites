<!DOCTYPE html>
<html>
  
<!-- Mirrored from blog.miguelgrinberg.com/post/the-flask-mega-tutorial-part-vii-unit-testing/page/3 by HTTrack Website Copier/3.x [XR&CO'2014], Fri, 14 Aug 2015 05:50:54 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head>
    
    <title>
    
        The Flask Mega-Tutorial, Part VII: Unit Testing - miguelgrinberg.com
    
</title>
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
	<meta name="description" content="miguelgrinberg.com">
	<meta name="copyright" content="Copyright (c) 2012-2015 Miguel Grinberg">
	<meta name="author" content="Miguel Grinberg">
    
    <meta name="keywords" content="python, programming, flask, web, tutorial, unit, test, testing, unit testing">
    

    
    <!-- Bootstrap -->
    <link href="../../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.0/css/bootstrap.min.css" rel="stylesheet" media="screen">
    <link href="../../../static/prettify.css" type="text/css" rel="stylesheet" />
    <link href="../../../static/colorbox/colorbox.css" rel="stylesheet" type="text/css" />
    <link href="../../../static/style.css" rel="stylesheet" type="text/css" />

    <link rel="shortcut icon" href="../../../static/favicon.ico">
	<link rel="alternate" type="application/rss+xml" href="../../../feed" title="miguelgrinberg.com RSS feed">

  </head>
  <body>
    
    <!-- facebook sdk -->
    <div id="fb-root"></div>
    <script>(function(d, s, id) {
      var js, fjs = d.getElementsByTagName(s)[0];
      if (d.getElementById(id)) return;
      js = d.createElement(s); js.id = id;
      js.src = "../../../../connect.facebook.net/en_US/all.js#xfbml=1";
      fjs.parentNode.insertBefore(js, fjs);
    }(document, 'script', 'facebook-jssdk'));</script>
    <!-- google plus sdk -->
    <script type="text/javascript" src="../../../../apis.google.com/js/plusone.js"></script>
    <!-- twitter sdk -->
    <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="../../../../platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>
    <!-- linkedin sdk -->
    <script src="../../../../platform.linkedin.com/in.js" type="text/javascript"></script>

    
    <nav class="navbar navbar-default" role="navigation">
        <div class="container-fluid">
            <div class="container">
                <div class="navbar-header">
                    <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                        <span class="sr-only">Toggle navigation</span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </button>
                    <a class="navbar-brand" href="http://blog.miguelgrinberg.com/index">miguelgrinberg.com</a>
                </div>
                <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
                    <ul class="nav navbar-nav">
                        <li><a href="http://blog.miguelgrinberg.com/index">Home</a></li>
                        <li><a href="../../about-me.html">About Me</a></li>
                        <li><a href="../../about-this-blog.html">About This Blog</a></li>
                        
                    </ul>
                    <ul class="nav navbar-nav navbar-right">
                        <li>
                            <p class="navbar-text" style="margin-top: 10px; margin-bottom: 0px;">
                                <a type="application/rss+xml" href="../../../feed"><img src="../../../static/rss.png" alt="RSS Feed" title="RSS Feed" /></a>
                                <a href="https://www.facebook.com/miguelgrinbergblog"><img src="../../../static/facebook.png" alt="Facebook" title="Facebook" /></a>
                                <a href="https://plus.google.com/u/0/117786742456929977820"><img src="../../../static/googleplus.png" alt="Google+" title="Google+" /></a>
                                <a href="http://www.linkedin.com/in/miguelgrinberg"><img src="../../../static/linkedin.png" alt="LinkedIn" title="LinkedIn" /></a>
                                <a href="http://github.com/miguelgrinberg"><img src="../../../static/github.png" alt="GitHub" title="GitHub" /></a>
                                <a href="https://twitter.com/#!/miguelgrinberg"><img src="../../../static/twitter.png" alt="Twitter" title="Twitter" /></a>
                            </p>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
        
    </nav>

    
    <div class="container">
        <div class="row">
            <div class="col-md-4 col-md-push-9 sidebar-bg">
                <div id="sidebar">
                    

                    
                    <h1>Building Web APIs with Flask</h1>
                    <p>Flask is the ideal Python framework for building REST APIs that are flexible, easy to maintain and efficient. I have created a training video with O'Reilly in which I show all my techniques:</p>
                    <p><center><a href="http://bit.ly/flaskapi"><img style="border: 1px solid black;" src="../../../static/flask-api-cover-tiny.png"></a></center></p>
                    <p>Visit <a href="http://flaskbook.com/">http://flaskbook.com</a> for information about this and other Flask training products I have created!</p>
                    

                    <h1>About Miguel</h1>
                    <img style="float: right; margin: 0px 8px 8px 0px; padding: 4px; border: 1px solid #ccc;" src="../../../static/miguel.jpg" />
                    <p>Welcome to my blog!</p>
                    <p>I'm a software engineer, photographer and filmmaker in Portland, Oregon, USA.</p>
                    <p>You can also find me on <a href="https://www.facebook.com/miguelgrinbergblog">Facebook</a>, <a href="https://plus.google.com/u/0/117786742456929977820">Google+</a>, <a href="http://www.linkedin.com/in/miguelgrinberg">LinkedIn</a>, <a href="https://github.com/miguelgrinberg">Github</a> and <a href="https://twitter.com/#!/miguelgrinberg">Twitter</a>.</p>
                    <p>Thank you for visiting!</p>

                    

                    
                    <h1>Categories</h1>
<ul>

	<li>
		<a href="http://blog.miguelgrinberg.com/category/Arduino/feed">
			<img src="../../../static/rss-small.png" title="Arduino RSS Feed" label="Arduino RSS Feed" />
		</a>
		<span class="label label-primary"><a href="http://blog.miguelgrinberg.com/category/Arduino">Arduino</a></span> (7)
	</li>

	<li>
		<a href="http://blog.miguelgrinberg.com/category/Authentication/feed">
			<img src="../../../static/rss-small.png" title="Authentication RSS Feed" label="Authentication RSS Feed" />
		</a>
		<span class="label label-primary"><a href="http://blog.miguelgrinberg.com/category/Authentication">Authentication</a></span> (4)
	</li>

	<li>
		<a href="http://blog.miguelgrinberg.com/category/Blog/feed">
			<img src="../../../static/rss-small.png" title="Blog RSS Feed" label="Blog RSS Feed" />
		</a>
		<span class="label label-primary"><a href="http://blog.miguelgrinberg.com/category/Blog">Blog</a></span> (1)
	</li>

	<li>
		<a href="http://blog.miguelgrinberg.com/category/C++/feed">
			<img src="../../../static/rss-small.png" title="C++ RSS Feed" label="C++ RSS Feed" />
		</a>
		<span class="label label-primary"><a href="http://blog.miguelgrinberg.com/category/C++">C++</a></span> (5)
	</li>

	<li>
		<a href="http://blog.miguelgrinberg.com/category/Cloud/feed">
			<img src="../../../static/rss-small.png" title="Cloud RSS Feed" label="Cloud RSS Feed" />
		</a>
		<span class="label label-primary"><a href="http://blog.miguelgrinberg.com/category/Cloud">Cloud</a></span> (2)
	</li>

	<li>
		<a href="http://blog.miguelgrinberg.com/category/Filmmaking/feed">
			<img src="../../../static/rss-small.png" title="Filmmaking RSS Feed" label="Filmmaking RSS Feed" />
		</a>
		<span class="label label-primary"><a href="http://blog.miguelgrinberg.com/category/Filmmaking">Filmmaking</a></span> (6)
	</li>

	<li>
		<a href="http://blog.miguelgrinberg.com/category/Flask/feed">
			<img src="../../../static/rss-small.png" title="Flask RSS Feed" label="Flask RSS Feed" />
		</a>
		<span class="label label-primary"><a href="http://blog.miguelgrinberg.com/category/Flask">Flask</a></span> (39)
	</li>

	<li>
		<a href="http://blog.miguelgrinberg.com/category/Games/feed">
			<img src="../../../static/rss-small.png" title="Games RSS Feed" label="Games RSS Feed" />
		</a>
		<span class="label label-primary"><a href="http://blog.miguelgrinberg.com/category/Games">Games</a></span> (1)
	</li>

	<li>
		<a href="http://blog.miguelgrinberg.com/category/Gear/feed">
			<img src="../../../static/rss-small.png" title="Gear RSS Feed" label="Gear RSS Feed" />
		</a>
		<span class="label label-primary"><a href="http://blog.miguelgrinberg.com/category/Gear">Gear</a></span> (6)
	</li>

	<li>
		<a href="http://blog.miguelgrinberg.com/category/HTML5/feed">
			<img src="../../../static/rss-small.png" title="HTML5 RSS Feed" label="HTML5 RSS Feed" />
		</a>
		<span class="label label-primary"><a href="http://blog.miguelgrinberg.com/category/HTML5">HTML5</a></span> (1)
	</li>

	<li>
		<a href="http://blog.miguelgrinberg.com/category/Heroku/feed">
			<img src="../../../static/rss-small.png" title="Heroku RSS Feed" label="Heroku RSS Feed" />
		</a>
		<span class="label label-primary"><a href="http://blog.miguelgrinberg.com/category/Heroku">Heroku</a></span> (1)
	</li>

	<li>
		<a href="http://blog.miguelgrinberg.com/category/Javascript/feed">
			<img src="../../../static/rss-small.png" title="Javascript RSS Feed" label="Javascript RSS Feed" />
		</a>
		<span class="label label-primary"><a href="http://blog.miguelgrinberg.com/category/Javascript">Javascript</a></span> (3)
	</li>

	<li>
		<a href="http://blog.miguelgrinberg.com/category/Movie Reviews/feed">
			<img src="../../../static/rss-small.png" title="Movie Reviews RSS Feed" label="Movie Reviews RSS Feed" />
		</a>
		<span class="label label-primary"><a href="http://blog.miguelgrinberg.com/category/Movie Reviews">Movie Reviews</a></span> (5)
	</li>

	<li>
		<a href="http://blog.miguelgrinberg.com/category/Netflix/feed">
			<img src="../../../static/rss-small.png" title="Netflix RSS Feed" label="Netflix RSS Feed" />
		</a>
		<span class="label label-primary"><a href="http://blog.miguelgrinberg.com/category/Netflix">Netflix</a></span> (5)
	</li>

	<li>
		<a href="http://blog.miguelgrinberg.com/category/Node.js/feed">
			<img src="../../../static/rss-small.png" title="Node.js RSS Feed" label="Node.js RSS Feed" />
		</a>
		<span class="label label-primary"><a href="../../../category/Node.html">Node.js</a></span> (1)
	</li>

	<li>
		<a href="http://blog.miguelgrinberg.com/category/OpenStack/feed">
			<img src="../../../static/rss-small.png" title="OpenStack RSS Feed" label="OpenStack RSS Feed" />
		</a>
		<span class="label label-primary"><a href="http://blog.miguelgrinberg.com/category/OpenStack">OpenStack</a></span> (1)
	</li>

	<li>
		<a href="http://blog.miguelgrinberg.com/category/Personal/feed">
			<img src="../../../static/rss-small.png" title="Personal RSS Feed" label="Personal RSS Feed" />
		</a>
		<span class="label label-primary"><a href="http://blog.miguelgrinberg.com/category/Personal">Personal</a></span> (1)
	</li>

	<li>
		<a href="http://blog.miguelgrinberg.com/category/Photography/feed">
			<img src="../../../static/rss-small.png" title="Photography RSS Feed" label="Photography RSS Feed" />
		</a>
		<span class="label label-primary"><a href="http://blog.miguelgrinberg.com/category/Photography">Photography</a></span> (6)
	</li>

	<li>
		<a href="http://blog.miguelgrinberg.com/category/Product Reviews/feed">
			<img src="../../../static/rss-small.png" title="Product Reviews RSS Feed" label="Product Reviews RSS Feed" />
		</a>
		<span class="label label-primary"><a href="http://blog.miguelgrinberg.com/category/Product Reviews">Product Reviews</a></span> (1)
	</li>

	<li>
		<a href="http://blog.miguelgrinberg.com/category/Programming/feed">
			<img src="../../../static/rss-small.png" title="Programming RSS Feed" label="Programming RSS Feed" />
		</a>
		<span class="label label-primary"><a href="http://blog.miguelgrinberg.com/category/Programming">Programming</a></span> (47)
	</li>

	<li>
		<a href="http://blog.miguelgrinberg.com/category/Project Management/feed">
			<img src="../../../static/rss-small.png" title="Project Management RSS Feed" label="Project Management RSS Feed" />
		</a>
		<span class="label label-primary"><a href="http://blog.miguelgrinberg.com/category/Project Management">Project Management</a></span> (1)
	</li>

	<li>
		<a href="http://blog.miguelgrinberg.com/category/Python/feed">
			<img src="../../../static/rss-small.png" title="Python RSS Feed" label="Python RSS Feed" />
		</a>
		<span class="label label-primary"><a href="http://blog.miguelgrinberg.com/category/Python">Python</a></span> (43)
	</li>

	<li>
		<a href="http://blog.miguelgrinberg.com/category/REST/feed">
			<img src="../../../static/rss-small.png" title="REST RSS Feed" label="REST RSS Feed" />
		</a>
		<span class="label label-primary"><a href="http://blog.miguelgrinberg.com/category/REST">REST</a></span> (5)
	</li>

	<li>
		<a href="http://blog.miguelgrinberg.com/category/Rackspace/feed">
			<img src="../../../static/rss-small.png" title="Rackspace RSS Feed" label="Rackspace RSS Feed" />
		</a>
		<span class="label label-primary"><a href="http://blog.miguelgrinberg.com/category/Rackspace">Rackspace</a></span> (1)
	</li>

	<li>
		<a href="http://blog.miguelgrinberg.com/category/Raspberry Pi/feed">
			<img src="../../../static/rss-small.png" title="Raspberry Pi RSS Feed" label="Raspberry Pi RSS Feed" />
		</a>
		<span class="label label-primary"><a href="http://blog.miguelgrinberg.com/category/Raspberry Pi">Raspberry Pi</a></span> (6)
	</li>

	<li>
		<a href="http://blog.miguelgrinberg.com/category/RhinoSteady/feed">
			<img src="../../../static/rss-small.png" title="RhinoSteady RSS Feed" label="RhinoSteady RSS Feed" />
		</a>
		<span class="label label-primary"><a href="http://blog.miguelgrinberg.com/category/RhinoSteady">RhinoSteady</a></span> (6)
	</li>

	<li>
		<a href="http://blog.miguelgrinberg.com/category/Robotics/feed">
			<img src="../../../static/rss-small.png" title="Robotics RSS Feed" label="Robotics RSS Feed" />
		</a>
		<span class="label label-primary"><a href="http://blog.miguelgrinberg.com/category/Robotics">Robotics</a></span> (6)
	</li>

	<li>
		<a href="http://blog.miguelgrinberg.com/category/Video/feed">
			<img src="../../../static/rss-small.png" title="Video RSS Feed" label="Video RSS Feed" />
		</a>
		<span class="label label-primary"><a href="http://blog.miguelgrinberg.com/category/Video">Video</a></span> (4)
	</li>

	<li>
		<a href="http://blog.miguelgrinberg.com/category/Windows/feed">
			<img src="../../../static/rss-small.png" title="Windows RSS Feed" label="Windows RSS Feed" />
		</a>
		<span class="label label-primary"><a href="http://blog.miguelgrinberg.com/category/Windows">Windows</a></span> (1)
	</li>

</ul>
                    
                </div>
            </div>
            <div class="col-md-8 col-md-pull-4">
                <div id="main">
                    
                    
                    
                    
                    

<div class="post">

<p class="date"><span class="flask-moment" data-timestamp="2012-08-01T06:50:31Z" data-format="format('LL')" data-refresh="0">2012-08-01T06:50:31Z</span></p>
<h1 class="post-title"><a href="../../the-flask-mega-tutorial-part-vii-unit-testing.html">The Flask Mega-Tutorial, Part VII: Unit Testing</a></h1>
<div class="posted">Posted by <span class="label label-danger"><a href="http://blog.miguelgrinberg.com/author/Miguel Grinberg">Miguel Grinberg</a></span> under <span class="label label-primary"><a href="http://blog.miguelgrinberg.com/category/Programming">Programming</a></span>, <span class="label label-primary"><a href="http://blog.miguelgrinberg.com/category/Python">Python</a></span>, <span class="label label-primary"><a href="http://blog.miguelgrinberg.com/category/Flask">Flask</a></span>. </div>
<div class="social-bar">
    <table>
        <tr>
            <td><div class="social-box" style="padding-top: 8px;"><a href="https://twitter.com/share" class="twitter-share-button" data-url="http://blog.miguelgrinberg.com/post/the-flask-mega-tutorial-part-vii-unit-testing" data-via="miguelgrinberg" data-count="vertical">Tweet</a></div></td>
            <td><div class="social-box" style="padding-left: 6px;"><div class="fb-like" data-href="http://blog.miguelgrinberg.com/post/the-flask-mega-tutorial-part-vii-unit-testing" data-send="false" data-layout="box_count" data-width="450" data-show-faces="false" data-font="verdana"></div></div></td>
            <td><div class="social-box" style="padding-top: 8px;"><g:plusone href="../../the-flask-mega-tutorial-part-vii-unit-testing.html" size="tall"></g:plusone></div></td>
            <td><div class="social-box" style="padding-top: 8px;"><script type="IN/Share" data-url="http://blog.miguelgrinberg.com/post/the-flask-mega-tutorial-part-vii-unit-testing" data-counter="top"></script></div></td>
        </tr>
    </table>
</div>
<div class="post_body"><p>This is the seventh article in the series in which I document my experience writing web applications in <a href="http://python.org/">Python</a> using the <a href="http://flask.pocoo.org/">Flask</a> microframework.</p>
<p>The goal of the tutorial series is to develop a decently featured microblogging application that demonstrating total lack of originality I have decided to call <code>microblog</code>.</p>
<p><strong>NOTE</strong>: This article was revised in September 2014 to be in sync with current versions of Python and Flask.</p>
<p>Here is an index of all the articles in the series that have been published to date:</p>
<ul>
<li><a href="../../the-flask-mega-tutorial-part-i-hello-world.html">Part I: Hello, World!</a></li>
<li><a href="../../the-flask-mega-tutorial-part-ii-templates.html">Part II: Templates</a></li>
<li><a href="../../the-flask-mega-tutorial-part-iii-web-forms.html">Part III: Web Forms</a></li>
<li><a href="../../the-flask-mega-tutorial-part-iv-database.html">Part IV: Database</a></li>
<li><a href="../../the-flask-mega-tutorial-part-v-user-logins.html">Part V: User Logins</a></li>
<li><a href="../../the-flask-mega-tutorial-part-vi-profile-page-and-avatars.html">Part VI: Profile Page And Avatars</a></li>
<li><a href="../../the-flask-mega-tutorial-part-vii-unit-testing.html">Part VII: Unit Testing</a> (this article)</li>
<li><a href="../../the-flask-mega-tutorial-part-viii-followers-contacts-and-friends.html">Part VIII: Followers, Contacts And Friends</a></li>
<li><a href="../../the-flask-mega-tutorial-part-ix-pagination.html">Part IX: Pagination</a></li>
<li><a href="../../the-flask-mega-tutorial-part-x-full-text-search.html">Part X: Full Text Search</a></li>
<li><a href="../../the-flask-mega-tutorial-part-xi-email-support.html">Part XI: Email Support</a></li>
<li><a href="../../the-flask-mega-tutorial-part-xii-facelift.html">Part XII: Facelift</a></li>
<li><a href="../../the-flask-mega-tutorial-part-xiii-dates-and-times.html">Part XIII: Dates and Times</a></li>
<li><a href="../../the-flask-mega-tutorial-part-xiv-i18n-and-l10n.html">Part XIV: I18n and L10n</a></li>
<li><a href="../../the-flask-mega-tutorial-part-xv-ajax.html">Part XV: Ajax</a></li>
<li><a href="../../the-flask-mega-tutorial-part-xvi-debugging-testing-and-profiling.html">Part XVI: Debugging, Testing and Profiling</a></li>
<li><a href="../../the-flask-mega-tutorial-part-xvii-deployment-on-linux-even-on-the-raspberry-pi.html">Part XVII: Deployment on Linux (even on the Raspberry Pi!)</a></li>
<li><a href="../../the-flask-mega-tutorial-part-xviii-deployment-on-the-heroku-cloud.html">Part XVIII: Deployment on the Heroku Cloud</a></li>
</ul>
<h2>Recap</h2>
<p>In the previous chapters of this tutorial we were concentrating in adding functionality to our little application, a step at a time. By now we have a database enabled application that can register users, log them in and out and let them view and edit their profiles.</p>
<p>In this session we are not going to add any new features to our application. Instead, we are going to find ways to add robustness to the code that we have already written, and we will also create a testing framework that will help us prevent failures and regressions in the future.</p>
<h2>Let's find a bug</h2>
<p>I mentioned at the end of the last chapter that I have intentionally introduced a bug in the application. Let me describe what the bug is, then we will use it to see what happens to our application when it does not work as expected.</p>
<p>The problem in the application is that there is no effort to keep the nicknames of our users unique. The initial nickname of a user is chosen automatically by the application. If the OpenID provider provides a nickname for the user then we will just use it. If not we will use the username part of the email address as nickname. If we get two users with the same nickname then the second one will not be able to register. To make matters worse, in the profile edit form we let users change their nicknames to whatever they want, and again there is no effort to avoid name collisions.</p>
<p>We will address these problems later, after we analyze how the application behaves when an error occurs.</p>
<h2>Flask debugging support</h2>
<p>So let's see what happens when we trigger our bug.</p>
<p>Let's start by creating a brand new database. On Linux:</p>
<pre><code>rm app.db
./db_create.py
</code></pre>
<p>or on Windows:</p>
<pre><code>del app.db
flask/Scripts/python db_create.py
</code></pre>
<p>You need two OpenID accounts to reproduce this bug, ideally from different providers, so that their cookies don't make this more complicated. Follow these steps to create a nickname collision:</p>
<ul>
<li>login with your first account</li>
<li>go to the edit profile page and change the nickname to 'dup'</li>
<li>logout</li>
<li>login with your second account</li>
<li>go to the edit profile page and change the nickname to 'dup'</li>
</ul>
<p>Oops! We've got an exception from sqlalchemy. The text of the error reads:</p>
<pre><code>sqlalchemy.exc.IntegrityError
IntegrityError: (IntegrityError) column nickname is not unique u'UPDATE user SET nickname=?, about_me=? WHERE user.id = ?' (u'dup', u'', 2)
</code></pre>
<p>What follows after the error is a <a href="http://en.wikipedia.org/wiki/Stack_trace">stack trace</a> of the error, and actually it is a pretty nice one, where you can go to any frame and inspect source code or even evaluate expressions right in the browser.</p>
<p>The error is pretty clear, we tried to insert a duplicated nickname in the database. The database model had a <code>unique</code> constrain on the <code>nickname</code> field, so this is an invalid operation.</p>
<p>In addition to the actual error, we have a secondary problem in our hands. If a user inadvertently causes an error in our application (this one or any other that causes an exception) it will be him or her that gets the error with the revealing error message and the stack trace, not us. While this is a fantastic feature while we are developing, it is something we definitely do not want our users to ever see.</p>
<p>All this time we have been running our application in <em>debug mode</em>. The debug mode is enabled when the application starts, by passing a <code>debug=True</code> argument to the <code>run</code> method. This is how we coded our <code>run.py</code> start-up script. </p>
<p>When we are developing the application this is convenient, but we need to make sure it is turned off when we run our application in <em>production mode</em>. Let's just create another starter script that runs with debugging disabled (file <code>runp.py</code>):</p>
<pre><code>#!flask/bin/python
from app import app
app.run(debug=False)
</code></pre>
<p>Now restart the application with:</p>
<pre><code>./runp.py
</code></pre>
<p>And now try again to rename the nickname on the second account to 'dup'.</p>
<p>This time we do not get an error. Instead, we get an HTTP error code 500, which is Internal Server Error. Not a great looking error, but at least we are not exposing any details of our application to strangers. The error 500 page is generated by Flask when debugging is off and an unhandled exception occurs.</p>
<p>While this is better, we are now having two new issues. First a cosmetic one: the default error 500 page is ugly. The second problem is much more important. With things as they are we would never know when and if a user experiences a failure in our application because when debugging is turned off application failures are silently dismissed. Luckily there are easy ways to address both problems.</p>
<h2>Custom HTTP error handlers</h2>
<p>Flask provides a mechanism for an application to install its own error pages. As an example, let's define custom error pages for the HTTP errors 404 and 500, the two most common ones. Defining pages for other errors works in the same way.</p>
<p>To declare a custom error handler the <code>errorhandler</code> decorator is used (file <code>app/views.py</code>):</p>
<pre><code>@app.errorhandler(404)
def not_found_error(error):
    return render_template('404.html'), 404

@app.errorhandler(500)
def internal_error(error):
    db.session.rollback()
    return render_template('500.html'), 500
</code></pre>
<p>Not much to talk about for these, as they are almost self-explanatory. The only interesting bit is the <code>rollback</code> statement in the error 500 handler. This is necessary because this function will be called as a result of an exception. If the exception was triggered by a database error then the database session is going to arrive in an invalid state, so we have to roll it back in case a working session is needed for the rendering of the template for the 500 error.</p>
<p>Here is the template for the 404 error:</p>
<pre><code>&lt;!-- extend base layout --&gt;
{% extends "base.html" %}

{% block content %}
  &lt;h1&gt;File Not Found&lt;/h1&gt;
  &lt;p&gt;&lt;a href="{{ url_for('index') }}"&gt;Back&lt;/a&gt;&lt;/p&gt;
{% endblock %}
</code></pre>
<p>And here is the one for the 500 error:</p>
<pre><code>&lt;!-- extend base layout --&gt;
{% extends "base.html" %}

{% block content %}
  &lt;h1&gt;An unexpected error has occurred&lt;/h1&gt;
  &lt;p&gt;The administrator has been notified. Sorry for the inconvenience!&lt;/p&gt;
  &lt;p&gt;&lt;a href="{{ url_for('index') }}"&gt;Back&lt;/a&gt;&lt;/p&gt;
{% endblock %}
</code></pre>
<p>Note that in both cases we continue to use our <code>base.html</code> layout, so that the error page has the look and feel of the application.</p>
<h2>Sending errors via email</h2>
<p>To address our second problem we are going to configure two reporting mechanisms for application errors. The first of them is to have the application send us an email each time an error occurs. </p>
<p>Before we get into this let's configure an email server and an administrator list in our application (file <code>config.py</code>):</p>
<pre><code># mail server settings
MAIL_SERVER = 'localhost'
MAIL_PORT = 25
MAIL_USERNAME = None
MAIL_PASSWORD = None

# administrator list
ADMINS = ['you@example.com']
</code></pre>
<p>Of course it will be up to you to change these to what makes sense.</p>
<p>Flask uses the regular Python <code>logging</code> module, so setting up an email when there is an exception is pretty easy (file <code>app/__init__.py</code>):</p>
<pre><code>from config import basedir, ADMINS, MAIL_SERVER, MAIL_PORT, MAIL_USERNAME, MAIL_PASSWORD

if not app.debug:
    import logging
    from logging.handlers import SMTPHandler
    credentials = None
    if MAIL_USERNAME or MAIL_PASSWORD:
        credentials = (MAIL_USERNAME, MAIL_PASSWORD)
    mail_handler = SMTPHandler((MAIL_SERVER, MAIL_PORT), 'no-reply@' + MAIL_SERVER, ADMINS, 'microblog failure', credentials)
    mail_handler.setLevel(logging.ERROR)
    app.logger.addHandler(mail_handler)
</code></pre>
<p>Note that we are only enabling the emails when we run without debugging.</p>
<p>Testing this on a development PC that does not have an email server is easy, thanks to Python's SMTP debugging server. Just open a new console window (command prompt for Windows users) and run the following to start a fake email server:</p>
<pre><code>python -m smtpd -n -c DebuggingServer localhost:25
</code></pre>
<p>When this is running, the emails sent by the application will be received and displayed in the console window.</p>
<h2>Logging to a file</h2>
<p>Receiving errors via email is nice, but sometimes this isn't enough. There are some failure conditions that do not end in an exception and aren't a major problem, yet we may want to keep track of them in a log in case we need to do some debugging.</p>
<p>For this reason, we are also going to maintain a log file for the application.</p>
<p>Enabling file logging is similar to the email logging (file <code>app/__init__.py</code>):</p>
<pre><code>if not app.debug:
    import logging
    from logging.handlers import RotatingFileHandler
    file_handler = RotatingFileHandler('tmp/microblog.log', 'a', 1 * 1024 * 1024, 10)
    file_handler.setFormatter(logging.Formatter('%(asctime)s %(levelname)s: %(message)s [in %(pathname)s:%(lineno)d]'))
    app.logger.setLevel(logging.INFO)
    file_handler.setLevel(logging.INFO)
    app.logger.addHandler(file_handler)
    app.logger.info('microblog startup')
</code></pre>
<p>The log file will go to our <code>tmp</code> directory, with name <code>microblog.log</code>. We are using the <code>RotatingFileHandler</code> so that there is a limit to the amount of logs that are generated. In this case we are limiting the size of a log file to one megabyte, and we will keep the last ten log files as backups.</p>
<p>The <code>logging.Formatter</code> class provides custom formatting for the log messages. Since these messages are going to a file, we want them to have as much information as possible, so we write a timestamp, the logging level and the file and line number where the message originated in addition to the log message and the stack trace.</p>
<p>To make the logging more useful, we are lowering the logging level, both in the app logger and the file logger handler, as this will give us the opportunity to write useful messages to the log without having to call them errors. As an example, we start by logging the application start up as an informational level. From now on, each time you start the application without debugging the log will record the event.</p>
<p>While we don't have a lot of need for a logger at this time, debugging a web server that is online and in use is very difficult. Logging messages to a file is an extremely useful tool in diagnosing and locating issues, so we are now all ready to go should we need to use this feature.</p>
<h2>The bug fix</h2>
<p>Let's fix our <code>nickname</code> duplication bug.</p>
<p>As discussed earlier, there are two places that are currently not handling duplicates. The first is in the <code>after_login</code> handler for Flask-Login. This is called when a user successfully logs in to the system and we need to create a new User instance. Here is the affected snippet of code, with the fix in it (file <code>app/views.py</code>):</p>
<pre><code>    if user is None:
        nickname = resp.nickname
        if nickname is None or nickname == "":
            nickname = resp.email.split('@')[0]
        nickname = User.make_unique_nickname(nickname)
        user = User(nickname = nickname, email = resp.email)
        db.session.add(user)
        db.session.commit()
</code></pre>
<p>The way we solve the problem is by letting the User class pick a unique name for us. This is what the new <code>make_unique_nickname</code> method does (file <code>app/models.py</code>):</p>
<pre><code>    class User(db.Model):
    # ...
    @staticmethod
    def make_unique_nickname(nickname):
        if User.query.filter_by(nickname=nickname).first() is None:
            return nickname
        version = 2
        while True:
            new_nickname = nickname + str(version)
            if User.query.filter_by(nickname=new_nickname).first() is None:
                break
            version += 1
        return new_nickname
    # ...
</code></pre>
<p>This method simply adds a counter to the requested nickname until a unique name is found. For example, if the username "miguel" exists, the method will suggest "miguel2", but if that also exists it will go to "miguel3" and so on. Note that we coded the method as a <a href="http://docs.python.org/library/functions.html#staticmethod">static method</a>, since it this operation does not apply to any particular instance of the class.</p>
<p>The second place where we have problems with duplicate nicknames is the view function for the edit profile page. This one is a little tricker to handle, because it is the user choosing the nickname. The correct thing to do here is to not accept a duplicated nickname and let the user enter another one. We will address this by adding custom validation to the nickname form field. If the user enters an invalid nickname we'll just fail the validation for the field, and that will send the user back to the edit profile page. To add our validation we just override the form's <code>validate</code> method (file <code>app/forms.py</code>):</p>
<pre><code>from app.models import User

class EditForm(Form):
    nickname = StringField('nickname', validators=[DataRequired()])
    about_me = TextAreaField('about_me', validators=[Length(min=0, max=140)])

    def __init__(self, original_nickname, *args, **kwargs):
        Form.__init__(self, *args, **kwargs)
        self.original_nickname = original_nickname

    def validate(self):
        if not Form.validate(self):
            return False
        if self.nickname.data == self.original_nickname:
            return True
        user = User.query.filter_by(nickname=self.nickname.data).first()
        if user != None:
            self.nickname.errors.append('This nickname is already in use. Please choose another one.')
            return False
        return True
</code></pre>
<p>The form constructor now takes a new argument <code>original_nickname</code>. The <code>validate</code> method uses it to determine if the nickname has changed or not. If it hasn't changed then it accepts it. If it has changed, then it makes sure the new nickname does not exist in the database.</p>
<p>Next we add the new constructor argument to the view function:</p>
<pre><code>@app.route('/edit', methods=['GET', 'POST'])
@login_required
def edit():
    form = EditForm(g.user.nickname)
    # ...
</code></pre>
<p>To complete this change we have to enable field errors to show in our template for the form (file <code>app/templates/edit.html</code>):</p>
<pre><code>        &lt;td&gt;Your nickname:&lt;/td&gt;
        &lt;td&gt;
            {{ form.nickname(size=24) }}
            {% for error in form.errors.nickname %}
            &lt;br&gt;&lt;span style="color: red;"&gt;[{{ error }}]&lt;/span&gt;
            {% endfor %}
        &lt;/td&gt;
</code></pre>
<p>Now the bug is fixed and duplicates will be prevented... except when they are not. We still have a potential problem with concurrent access to the database by two or more threads or processes, but this will be the topic of a future article.</p>
<p>At this point you can try again to select a duplicated name to see how the form nicely handles the error.</p>
<h2>Unit testing framework</h2>
<p>To close this session on testing, let's talk about automated testing a bit.</p>
<p>As the application grows in size it gets more and more difficult to ensure that code changes don't break existing functionality.</p>
<p>The traditional approach to prevent regressions is a very good one. You write tests that exercise all the different features of the application. Each test runs a focused part and verifies that the result obtained is the expected one. The tests are executed periodically to make sure that the application works as expected. When the test <em>coverage</em> is large you can have confidence that modifications and additions do not affect the application in a bad way just by running the tests.</p>
<p>We will now build a very simple testing framework using Python's <code>unittest</code> module (file <code>tests.py</code>):</p>
<pre><code>#!flask/bin/python
import os
import unittest

from config import basedir
from app import app, db
from app.models import User

class TestCase(unittest.TestCase):
    def setUp(self):
        app.config['TESTING'] = True
        app.config['WTF_CSRF_ENABLED'] = False
        app.config['SQLALCHEMY_DATABASE_URI'] = 'sqlite:///' + os.path.join(basedir, 'test.db')
        self.app = app.test_client()
        db.create_all()

    def tearDown(self):
        db.session.remove()
        db.drop_all()

    def test_avatar(self):
        u = User(nickname='john', email='john@example.com')
        avatar = u.avatar(128)
        expected = 'http://www.gravatar.com/avatar/d4c74594d841139328695756648b6bd6'
        assert avatar[0:len(expected)] == expected

    def test_make_unique_nickname(self):
        u = User(nickname='john', email='john@example.com')
        db.session.add(u)
        db.session.commit()
        nickname = User.make_unique_nickname('john')
        assert nickname != 'john'
        u = User(nickname=nickname, email='susan@example.com')
        db.session.add(u)
        db.session.commit()
        nickname2 = User.make_unique_nickname('john')
        assert nickname2 != 'john'
        assert nickname2 != nickname

if __name__ == '__main__':
    unittest.main()
</code></pre>
<p>Discussing the <code>unittest</code> module is outside the scope of this article. Let's just say that class <code>TestCase</code> holds our tests. The <code>setUp</code> and <code>tearDown</code> methods are special, these are run before and after each test respectively. A more complex setup could include several groups of tests each represented by a <code>unittest.TestCase</code> subclass, and each group then would have independent <code>setUp</code> and <code>tearDown</code> methods. </p>
<p>These particular <code>setUp</code> and <code>tearDown</code> methods are pretty generic. In <code>setUp</code> the configuration is edited a bit. For instance, we want the testing database to be different that the main database. In <code>tearDown</code> we just reset the database contents.</p>
<p>Tests are implemented as methods. A test is supposed to run some function of the application that has a known outcome, and should assert if the result is different than the expected one.</p>
<p>So far we have two tests in the testing framework. The first one verifies that the Gravatar avatar URLs from the previous article are generated correctly. Note how the expected avatar is hardcoded in the test and checked against the one returned by the <code>User</code> class.</p>
<p>The second test verifies the <code>make_unique_nickname</code> method we just wrote, also in the <code>User</code> class. This test is a bit more elaborate, it creates a new user and writes it to the database, then ensures the same name is not allowed as a unique name. It then creates a second user with the suggested unique name and tries one more time to request the first nickname. The expected result for this second part is to get a suggested nickname that is different from the previous two.</p>
<p>To run the test suite you just run the <code>tests.py</code> script:</p>
<pre><code>python tests.py
</code></pre>
<p>If there are any errors, you will get a report in the console.</p>
<h2>Final words</h2>
<p>This ends today's discussion of debugging, errors and testing. I hope you found this article useful.</p>
<p>As always, if you have any comments please write below.</p>
<p>The code of the microblog application update with today's changes is available below for download:</p>
<p>Download <a href="https://codeload.github.com/miguelgrinberg/microblog/zip/version-0.7">microblog-0.7.zip</a>.</p>
<p>As always, the flask virtual environment and the database are not included. See previous articles for instructions on how to generate them.</p>
<p>I hope to see you again in the next installment of this series.</p>
<p>Thank you for reading!</p>
<p>Miguel</p></div>
<div class="social-bar">
    <table>
        <tr>
            <td><div class="social-box" style="padding-top: 8px;"><a href="https://twitter.com/share" class="twitter-share-button" data-url="http://blog.miguelgrinberg.com/post/the-flask-mega-tutorial-part-vii-unit-testing" data-via="miguelgrinberg" data-count="vertical">Tweet</a></div></td>
            <td><div class="social-box" style="padding-left: 6px;"><div class="fb-like" data-href="http://blog.miguelgrinberg.com/post/the-flask-mega-tutorial-part-vii-unit-testing" data-send="false" data-layout="box_count" data-width="450" data-show-faces="false" data-font="verdana"></div></div></td>
            <td><div class="social-box" style="padding-top: 8px;"><g:plusone href="../../the-flask-mega-tutorial-part-vii-unit-testing.html" size="tall"></g:plusone></div></td>
            <td><div class="social-box" style="padding-top: 8px;"><script type="IN/Share" data-url="http://blog.miguelgrinberg.com/post/the-flask-mega-tutorial-part-vii-unit-testing" data-counter="top"></script></div></td>
        </tr>
    </table>
</div>


<h4 style="text-align: right"><a name="comments"></a>82 comments</h4>


<div class="comment">
    <ul>
        
        <li>
            <div class="comment-thumbnail"><img src="../../../../gravatar.com/avatar/4d3c6bd29c14aafb6634148d46fc9448ce2c.png?s=60&amp;d=identicon" /></div>
            <div class="comment-body">
                <p>
                    <span class="label label-default">#51</span> <span class="label label-primary">singh</span> said
                    <span class="flask-moment" data-timestamp="2014-05-18T03:59:23Z" data-format="fromNow(0)" data-refresh="0">2014-05-18T03:59:23Z</span>
                </p>
                <div style="overflow: auto;">
                    <p style="white-space: pre-wrap;">hello 

thanks for tutorial


i want to check in database during signup email and username if already exist.

use this give me error __init__() takes at least 3 arguments (2 given)


code here

	def __init__(self, original_username, original_email, *args, **kwargs ):
		Form.__init__(self, *args, **kwargs)
		self.original_username = original_username
		self.original_email = original_email
		
		
	def validate(self):
		if not Form.validate(self):
			return False
				
		if self.username.data == self.original_username and self.email.data == self.original_email:
			return True
			
		susers = User.query.filter_by(username = self.username.data).first()
		
		if susers != None:
			self.username.errors.append(&#39;username is already exist try anothor one.&#39;)
			return False

		
		if susers.email != None:
			self.email.errors.append(&#39;email is already exist try anothor one.&#39;)
			return False
			
		return True	


plese help me 
</p>
                </div>
            </div>
        </li>
        
        <li>
            <div class="comment-thumbnail"><img src="../../../../gravatar.com/avatar/a645e51db7c5dc7b0d4093f96dcbb3d6ce2c.png?s=60&amp;d=identicon" /></div>
            <div class="comment-body">
                <p>
                    <span class="label label-default">#52</span> <span class="label label-primary">Matt</span> said
                    <span class="flask-moment" data-timestamp="2014-07-24T14:55:59Z" data-format="fromNow(0)" data-refresh="0">2014-07-24T14:55:59Z</span>
                </p>
                <div style="overflow: auto;">
                    <p style="white-space: pre-wrap;">Hey, Excellent series. I&#39;m running through at the moment! 

I currently script (badly, when needed) in Python but have never successfully created a web-app i&#39;m proud of. These tutorials are immensely useful!

However, am I following the &#39;right&#39; path? 2014 is not 2012 and things evolve quickly in this space.

Is there something else I should be looking at two years on...? If i&#39;m looking to create a clean, modern webapp using twitter bootstrap. Is Flask going to cause me issues? Especially if I want to start looking into websockets at a later date and heavy use of html5 functionality?

Kind Regards and once again, excellent work. your writing style flows really well and aids understanding.
Matt</p>
                </div>
            </div>
        </li>
        
        <li>
            <div class="comment-thumbnail"><img src="../../../../gravatar.com/avatar/729e26a2a2c7ff24a71958d4aa4e5f35ce2c.jpeg?s=60&amp;d=identicon" /></div>
            <div class="comment-body">
                <p>
                    <span class="label label-default">#53</span> <span class="label label-danger">Miguel Grinberg</span> said
                    <span class="flask-moment" data-timestamp="2014-07-25T04:11:36Z" data-format="fromNow(0)" data-refresh="0">2014-07-25T04:11:36Z</span>
                </p>
                <div style="overflow: auto;">
                    <p style="white-space: pre-wrap;">@Matt: this tutorial does not work as is on Python 3, you will need to make some minor changes. Two years ago Flask did not support Py3, so I did not test on that version. If you are willing to spend money, then my book presents a more rounded application, not only because I&#39;m writing Py2 and Py3 compatible code, but also because I learned more tricks in the last two years. Thanks!</p>
                </div>
            </div>
        </li>
        
        <li>
            <div class="comment-thumbnail"><img src="../../../../gravatar.com/avatar/dca9156d8a2b2d5ed984af4eb7cdc00ace2c.jpeg?s=60&amp;d=identicon" /></div>
            <div class="comment-body">
                <p>
                    <span class="label label-default">#54</span> <span class="label label-primary"><a href="http://upasana.me/">upasana</a></span> said
                    <span class="flask-moment" data-timestamp="2014-07-28T23:23:00Z" data-format="fromNow(0)" data-refresh="0">2014-07-28T23:23:00Z</span>
                </p>
                <div style="overflow: auto;">
                    <p style="white-space: pre-wrap;">Hi! Thanks for this great tutorial, very helpful! 
In &#34;Bug Fix&#34; section, you have this line in app/forms.py in the tutorial, but not in the zip file:
from app.models import User;
</p>
                </div>
            </div>
        </li>
        
        <li>
            <div class="comment-thumbnail"><img src="../../../../gravatar.com/avatar/2eb9f1ee14da7fb9701287b2d7b7754dce2c.png?s=60&amp;d=identicon" /></div>
            <div class="comment-body">
                <p>
                    <span class="label label-default">#55</span> <span class="label label-primary"><a href="http://kevgathuku.com/">Kevin</a></span> said
                    <span class="flask-moment" data-timestamp="2014-10-09T10:19:05Z" data-format="fromNow(0)" data-refresh="0">2014-10-09T10:19:05Z</span>
                </p>
                <div style="overflow: auto;">
                    <p style="white-space: pre-wrap;">Very informative article. Thanks for taking the time to write this.

I have on question regarding the tests, Why are we setting this setting in the tests module to False?
app.config[&#39;WTF_CSRF_ENABLED&#39;] = False</p>
                </div>
            </div>
        </li>
        
        <li>
            <div class="comment-thumbnail"><img src="../../../../gravatar.com/avatar/729e26a2a2c7ff24a71958d4aa4e5f35ce2c.jpeg?s=60&amp;d=identicon" /></div>
            <div class="comment-body">
                <p>
                    <span class="label label-default">#56</span> <span class="label label-danger">Miguel Grinberg</span> said
                    <span class="flask-moment" data-timestamp="2014-10-09T16:41:47Z" data-format="fromNow(0)" data-refresh="0">2014-10-09T16:41:47Z</span>
                </p>
                <div style="overflow: auto;">
                    <p style="white-space: pre-wrap;">@Kevin: if you have CSRF enabled during testing you will need to send a CSRF token with every form submitted by the test, which makes submitting forms more complicated. This is intended to be used in production to protect against attacks, there is no point in using CSRF protection in tests, unless that is what you are testing.</p>
                </div>
            </div>
        </li>
        
        <li>
            <div class="comment-thumbnail"><img src="../../../../gravatar.com/avatar/729e26a2a2c7ff24a71958d4aa4e5f35ce2c.jpeg?s=60&amp;d=identicon" /></div>
            <div class="comment-body">
                <p>
                    <span class="label label-default">#57</span> <span class="label label-danger">Miguel Grinberg</span> said
                    <span class="flask-moment" data-timestamp="2014-10-09T16:41:47Z" data-format="fromNow(0)" data-refresh="0">2014-10-09T16:41:47Z</span>
                </p>
                <div style="overflow: auto;">
                    <p style="white-space: pre-wrap;">@Kevin: if you have CSRF enabled during testing you will need to send a CSRF token with every form submitted by the test, which makes submitting forms more complicated. This is intended to be used in production to protect against attacks, there is no point in using CSRF protection in tests, unless that is what you are testing.</p>
                </div>
            </div>
        </li>
        
        <li>
            <div class="comment-thumbnail"><img src="../../../../gravatar.com/avatar/7ddd18c9983784c52478dcf7a94bead9ce2c.png?s=60&amp;d=identicon" /></div>
            <div class="comment-body">
                <p>
                    <span class="label label-default">#58</span> <span class="label label-primary">jone</span> said
                    <span class="flask-moment" data-timestamp="2014-10-13T08:15:12Z" data-format="fromNow(0)" data-refresh="0">2014-10-13T08:15:12Z</span>
                </p>
                <div style="overflow: auto;">
                    <p style="white-space: pre-wrap;">dear Miguel:
        thanks for your great tutorials.
	And i have a problem with my unittest when i ran the test case like below ,it returns an IntegrityError which indicates that i made a duplicate entry in generating an area like this:

IntegrityError: (IntegrityError) (1062, &#34;Duplicate entry &#39;x00&#39; for key &#39;areaname&#39;&#34;) &#39;INSERT INTO area (areaname) VALUES (%s)&#39; (&#39;x00&#39;,)


and the test case is :
	def test_area_service(self):
        a1 = Area(areaname=&#39;x00&#39;)
        s1 = Service(servicename = &#39;n00&#39;)
        db.session.add(a1)
        db.session.add(s1)
        db.session.commit()
        assert a1.rm_service(s1) is None
        a = a1.add_service(s1)
        db.session.add(a)
        db.session.commit()
        assert a1.add_service(s1) is None
        assert a1.has_service(s1)
        assert a1.services.count() == 1
        assert a1.services.first().servicename == &#39;n00&#39;
        assert s1.area.count() == 1
        assert s1.area.first().areaname == &#39;x00&#39;
        a = a1.rm_service(s1)
        assert a is not None
        db.session.add(a)
        db.session.commit()
        assert not a1.has_service(s1)
        assert a1.services.count() == 0
        assert s1.area.count() == 0

and i already removed session in tearDown methods. But if i print the all area before init an new area, it outputs all areas that was created when running this test case before. it seems like the tearDown method did not drop all record in table ? the tearDown and  setUp is as below:

def setUp(self):
        app.config[&#39;TESTING&#39;] = True
        app.config[&#39;WTF_CSRF_ENABLED&#39;] = False
        app.config[&#39;SQLALCHEMY_DATABASE_URI&#39;] = &#39;mysql://root:root@localhost/newtest&#39;
        self.app = app.test_client()
        # db.session.remove()
        db.create_all()

        

def tearDown(self):
        db.session.remove()
        db.drop_all()

and the ways i figure this problem is to remove session in setUp method, the output is turned out that it runs like i expected. and i don&#39;t know whether it is proper way to resolve this question. any help would be appreciated. thanks again!</p>
                </div>
            </div>
        </li>
        
        <li>
            <div class="comment-thumbnail"><img src="../../../../gravatar.com/avatar/729e26a2a2c7ff24a71958d4aa4e5f35ce2c.jpeg?s=60&amp;d=identicon" /></div>
            <div class="comment-body">
                <p>
                    <span class="label label-default">#59</span> <span class="label label-danger">Miguel Grinberg</span> said
                    <span class="flask-moment" data-timestamp="2014-10-15T01:40:42Z" data-format="fromNow(0)" data-refresh="0">2014-10-15T01:40:42Z</span>
                </p>
                <div style="overflow: auto;">
                    <p style="white-space: pre-wrap;">@jone: without seeing all the code is hard to say, but you can get a clue if you check which line of your test is generating the integrity error.</p>
                </div>
            </div>
        </li>
        
        <li>
            <div class="comment-thumbnail"><img src="../../../../gravatar.com/avatar/d2e81469499adfa1ec36f771d657ac92ce2c.jpeg?s=60&amp;d=identicon" /></div>
            <div class="comment-body">
                <p>
                    <span class="label label-default">#60</span> <span class="label label-primary">Fintan Halpenny</span> said
                    <span class="flask-moment" data-timestamp="2014-10-22T16:27:00Z" data-format="fromNow(0)" data-refresh="0">2014-10-22T16:27:00Z</span>
                </p>
                <div style="overflow: auto;">
                    <p style="white-space: pre-wrap;">I&#39;ve been following your blog and so far it&#39;s great! Unfortunately, I&#39;ve come across a problem. When running the unit tests there seems to be a problem. When I run the tests script the assertion, nickname2 != &#39;john&#39; fails for some reason. 

I did some print statements to try and see what&#39;s going on and nickname2 is getting instantiated to &#39;john&#39; and I also noticed that the test is looking at the app.db strangely enough... 

Any insight into this problem?</p>
                </div>
            </div>
        </li>
        
        <li>
            <div class="comment-thumbnail"><img src="../../../../gravatar.com/avatar/729e26a2a2c7ff24a71958d4aa4e5f35ce2c.jpeg?s=60&amp;d=identicon" /></div>
            <div class="comment-body">
                <p>
                    <span class="label label-default">#61</span> <span class="label label-danger">Miguel Grinberg</span> said
                    <span class="flask-moment" data-timestamp="2014-10-22T21:24:17Z" data-format="fromNow(0)" data-refresh="0">2014-10-22T21:24:17Z</span>
                </p>
                <div style="overflow: auto;">
                    <p style="white-space: pre-wrap;">@Fintan: odd. The database should be test.db, this filename is initialized in the setUp() method of the test case. The way microblog sets up the test.db database is not the cleanest, I have improved this in my more recent material, so there is chance something isn&#39;t working right. The strange thing is that it works fine for me here.

Have you compared your version of the app with mine on GitHub?</p>
                </div>
            </div>
        </li>
        
        <li>
            <div class="comment-thumbnail"><img src="../../../../gravatar.com/avatar/d2e81469499adfa1ec36f771d657ac92ce2c.jpeg?s=60&amp;d=identicon" /></div>
            <div class="comment-body">
                <p>
                    <span class="label label-default">#62</span> <span class="label label-primary">Fintan Halpenny</span> said
                    <span class="flask-moment" data-timestamp="2014-10-24T11:35:40Z" data-format="fromNow(0)" data-refresh="0">2014-10-24T11:35:40Z</span>
                </p>
                <div style="overflow: auto;">
                    <p style="white-space: pre-wrap;">@Miguel: I&#39;ve compared my code to yours on GitHub and made sure I re-wrote several times now. I continued to try debug the program and I think the database issue is fixed, to a certain extent. 

So I&#39;ve tried printing out some things to see what&#39;s going on and for some reason after the second commit to the database it becomes empty?! Weird, right?

Here&#39;s my code and my output (also the printing doesn&#39;t go in order during the test module, maybe this is the reason? Is it tested concurrently rather than sequentially?):

http://pastebin.com/PRmgcnAZ</p>
                </div>
            </div>
        </li>
        
        <li>
            <div class="comment-thumbnail"><img src="../../../../gravatar.com/avatar/729e26a2a2c7ff24a71958d4aa4e5f35ce2c.jpeg?s=60&amp;d=identicon" /></div>
            <div class="comment-body">
                <p>
                    <span class="label label-default">#63</span> <span class="label label-danger">Miguel Grinberg</span> said
                    <span class="flask-moment" data-timestamp="2014-10-25T17:37:53Z" data-format="fromNow(0)" data-refresh="0">2014-10-25T17:37:53Z</span>
                </p>
                <div style="overflow: auto;">
                    <p style="white-space: pre-wrap;">@Fintan: I&#39;m not sure I understand the problem. The output that you referenced looks fine to me. You start with an empty db and then add user &#34;john&#34;. When you ask for &#34;susan&#34; you get the name since it is not available, then when you ask for &#34;john&#34; again you get &#34;john2&#34;. That is how this is supposed to work.</p>
                </div>
            </div>
        </li>
        
        <li>
            <div class="comment-thumbnail"><img src="../../../../gravatar.com/avatar/374affb4db58caa9507f265d7fdf03fece2c.jpeg?s=60&amp;d=identicon" /></div>
            <div class="comment-body">
                <p>
                    <span class="label label-default">#64</span> <span class="label label-primary">Fintan Halpenny</span> said
                    <span class="flask-moment" data-timestamp="2014-10-26T20:39:32Z" data-format="fromNow(0)" data-refresh="0">2014-10-26T20:39:32Z</span>
                </p>
                <div style="overflow: auto;">
                    <p style="white-space: pre-wrap;">@Miguel: No you might notice that I&#39;ve added the number of when I go to make unique names. When n=3 (when I&#39;m instantiating nickname2) the database should hold &#34;john&#34; and &#34;john2&#34; but instead it is empty? I&#39;m presuming nickname2 is supposed end up holding the value &#34;john3&#34; but instead it will become &#34;john&#34; which makes the assertion that I commented out fail. </p>
                </div>
            </div>
        </li>
        
        <li>
            <div class="comment-thumbnail"><img src="../../../../gravatar.com/avatar/729e26a2a2c7ff24a71958d4aa4e5f35ce2c.jpeg?s=60&amp;d=identicon" /></div>
            <div class="comment-body">
                <p>
                    <span class="label label-default">#65</span> <span class="label label-danger">Miguel Grinberg</span> said
                    <span class="flask-moment" data-timestamp="2014-10-27T00:56:21Z" data-format="fromNow(0)" data-refresh="0">2014-10-27T00:56:21Z</span>
                </p>
                <div style="overflow: auto;">
                    <p style="white-space: pre-wrap;">@Fintan: did not notice the numbers. I&#39;m really confused about the 3,1,2 sequence, that makes no sense. I recommend that you debug that test and follow it line by line to see why that happens. The free PyCharm IDE has a very good interactive debugger if you have never used one.</p>
                </div>
            </div>
        </li>
        
        <li>
            <div class="comment-thumbnail"><img src="../../../../gravatar.com/avatar/374affb4db58caa9507f265d7fdf03fece2c.jpeg?s=60&amp;d=identicon" /></div>
            <div class="comment-body">
                <p>
                    <span class="label label-default">#66</span> <span class="label label-primary">@Miguel</span> said
                    <span class="flask-moment" data-timestamp="2014-10-27T08:53:08Z" data-format="fromNow(0)" data-refresh="0">2014-10-27T08:53:08Z</span>
                </p>
                <div style="overflow: auto;">
                    <p style="white-space: pre-wrap;">@Miguel: Haha you&#39;re not the only one confused. The out of order numbers implies, to me, that the code isn&#39;t being executed sequentially, but that wouldn&#39;t make any sense what so ever... I&#39;ll give it a go in PyCharm none the less. Thanks for the help!</p>
                </div>
            </div>
        </li>
        
        <li>
            <div class="comment-thumbnail"><img src="../../../../gravatar.com/avatar/aa9f94f5b96778b15645a693ca616ee0ce2c.png?s=60&amp;d=identicon" /></div>
            <div class="comment-body">
                <p>
                    <span class="label label-default">#67</span> <span class="label label-primary">jalnanco</span> said
                    <span class="flask-moment" data-timestamp="2014-11-26T14:22:47Z" data-format="fromNow(0)" data-refresh="0">2014-11-26T14:22:47Z</span>
                </p>
                <div style="overflow: auto;">
                    <p style="white-space: pre-wrap;">@Seth second error - change directory like :
RotatingFileHandler(os.path.join(basedir, &#39;tmp/microblog.log&#39;), &#34;a&#34;, 1*1024*1024, 10)</p>
                </div>
            </div>
        </li>
        
        <li>
            <div class="comment-thumbnail"><img src="../../../../gravatar.com/avatar/d9f3c939cf9570ad4af6261be2c1096ece2c.png?s=60&amp;d=identicon" /></div>
            <div class="comment-body">
                <p>
                    <span class="label label-default">#68</span> <span class="label label-primary">sacha</span> said
                    <span class="flask-moment" data-timestamp="2014-12-08T20:42:48Z" data-format="fromNow(0)" data-refresh="0">2014-12-08T20:42:48Z</span>
                </p>
                <div style="overflow: auto;">
                    <p style="white-space: pre-wrap;">@Seth: binding any port &lt; 1024 requires superuser privileges. What I did is change the port to 2525 in config.py and in the command for launching DebuggingServer. See http://stackoverflow.com/questions/25709716/socket-error-errno-13-permission-denied-when-creating-a-fake-email-server</p>
                </div>
            </div>
        </li>
        
        <li>
            <div class="comment-thumbnail"><img src="../../../../gravatar.com/avatar/c5b3f257a0f3baf464b621f4601672b7ce2c.png?s=60&amp;d=identicon" /></div>
            <div class="comment-body">
                <p>
                    <span class="label label-default">#69</span> <span class="label label-primary"><a href="www.last.fm/user/andro92meda.html">Andromeda</a></span> said
                    <span class="flask-moment" data-timestamp="2015-01-09T09:09:24Z" data-format="fromNow(0)" data-refresh="0">2015-01-09T09:09:24Z</span>
                </p>
                <div style="overflow: auto;">
                    <p style="white-space: pre-wrap;">Hi Miguel,

Thanks for this great Tutor. I have an issue here. I can&#39;t run the tests.py file. The output is same on Gator&#39;s error on the first article. Here is the output:

bash: ./tests.py: flask/bin/python: bad interpreter: No such file or directory

It looks like some minor problem at the instalation, whereas I&#39;ve installed it correctly as you describe on the &#34;Installing Flask&#34; section in the first article. 
What&#39;s going wrong with my project?
Any respond would be very appreciated, Miguel.

Thank a lot in advance</p>
                </div>
            </div>
        </li>
        
        <li>
            <div class="comment-thumbnail"><img src="../../../../gravatar.com/avatar/729e26a2a2c7ff24a71958d4aa4e5f35ce2c.jpeg?s=60&amp;d=identicon" /></div>
            <div class="comment-body">
                <p>
                    <span class="label label-default">#70</span> <span class="label label-danger">Miguel Grinberg</span> said
                    <span class="flask-moment" data-timestamp="2015-01-09T18:00:09Z" data-format="fromNow(0)" data-refresh="0">2015-01-09T18:00:09Z</span>
                </p>
                <div style="overflow: auto;">
                    <p style="white-space: pre-wrap;">@Andromeda: you probably have a virtualenv that is not named &#34;flask&#34;. You can fix the shebang line (first line in the script) to match the location of your python interpreter, or else you can invoke the script using &#34;python tests.py&#34;.</p>
                </div>
            </div>
        </li>
        
        <li>
            <div class="comment-thumbnail"><img src="../../../../gravatar.com/avatar/bc5c2edec95f644a39cd0795191a51e9ce2c.png?s=60&amp;d=identicon" /></div>
            <div class="comment-body">
                <p>
                    <span class="label label-default">#71</span> <span class="label label-primary"><a href="www.last.fm/user/andro92meda.html">Andromeda</a></span> said
                    <span class="flask-moment" data-timestamp="2015-01-12T07:07:52Z" data-format="fromNow(0)" data-refresh="0">2015-01-12T07:07:52Z</span>
                </p>
                <div style="overflow: auto;">
                    <p style="white-space: pre-wrap;">No, my virtualenv name is &#39;flask&#39;. The activated interpreter is absolutely shows that, with the &#34;(flask)&#34; on the beginning of the prompt.

Which script file are you mean in &#34;(first line in the script)&#34;? The &#39;tests.py&#39; file?

I have tried your suggest to run with &#34;python tests.py&#34;, now the output is:
Traceback (most recent call last):
  File &#34;tests.py&#34;, line 5, in &lt;module&gt;
    from config import basedir
ImportError: No module named config
(flask)andromeda@alros-server:~$

I&#39;m an absolute amateur newbie in virtualenv, so I don&#39;t understand how to use it correctly. Any help would be very appreciated. Thanks in advance.</p>
                </div>
            </div>
        </li>
        
        <li>
            <div class="comment-thumbnail"><img src="../../../../gravatar.com/avatar/729e26a2a2c7ff24a71958d4aa4e5f35ce2c.jpeg?s=60&amp;d=identicon" /></div>
            <div class="comment-body">
                <p>
                    <span class="label label-default">#72</span> <span class="label label-danger">Miguel Grinberg</span> said
                    <span class="flask-moment" data-timestamp="2015-01-12T15:50:45Z" data-format="fromNow(0)" data-refresh="0">2015-01-12T15:50:45Z</span>
                </p>
                <div style="overflow: auto;">
                    <p style="white-space: pre-wrap;">@Andromeda: do you have a &#34;config.py&#34; file in the same directory as &#34;tests.py&#34;? The last error that you get seems to suggest you don&#39;t.</p>
                </div>
            </div>
        </li>
        
        <li>
            <div class="comment-thumbnail"><img src="../../../../gravatar.com/avatar/bc5c2edec95f644a39cd0795191a51e9ce2c.png?s=60&amp;d=identicon" /></div>
            <div class="comment-body">
                <p>
                    <span class="label label-default">#73</span> <span class="label label-primary"><a href="www.last.fm/user/andro92meda.html">Andromeda</a></span> said
                    <span class="flask-moment" data-timestamp="2015-01-13T03:31:05Z" data-format="fromNow(0)" data-refresh="0">2015-01-13T03:31:05Z</span>
                </p>
                <div style="overflow: auto;">
                    <p style="white-space: pre-wrap;">Ups, evidently the problem just on the directory structure. I&#39;ve
 move the tests.py to microblog dir and now the result is:
(flask)andromeda@alros-server:~$ ./tests.py 
Traceback (most recent call last):
  File &#34;/usr/lib/python2.7/logging/handlers.py&#34;, line 76, in emit
    if self.shouldRollover(record):
  File &#34;/usr/lib/python2.7/logging/handlers.py&#34;, line 156, in shouldRollover
    msg = &#34;%s\n&#34; % self.format(record)
  File &#34;/usr/lib/python2.7/logging/__init__.py&#34;, line 724, in format
    return fmt.format(record)
  File &#34;/usr/lib/python2.7/logging/__init__.py&#34;, line 467, in format
    s = self._fmt % record.__dict__
TypeError: not enough arguments for format string
Logged from file __init__.py, line 41
..
----------------------------------------------------------------------
Ran 2 tests in 1.198s

OK


Is this was a right result of the test run?
Thanks in advance.</p>
                </div>
            </div>
        </li>
        
        <li>
            <div class="comment-thumbnail"><img src="../../../../gravatar.com/avatar/729e26a2a2c7ff24a71958d4aa4e5f35ce2c.jpeg?s=60&amp;d=identicon" /></div>
            <div class="comment-body">
                <p>
                    <span class="label label-default">#74</span> <span class="label label-danger">Miguel Grinberg</span> said
                    <span class="flask-moment" data-timestamp="2015-01-14T02:55:36Z" data-format="fromNow(0)" data-refresh="0">2015-01-14T02:55:36Z</span>
                </p>
                <div style="overflow: auto;">
                    <p style="white-space: pre-wrap;">@Andromeda: the unit tests are running and passing. Not sure what is this logging error that you get, but it is not related to the application tests.</p>
                </div>
            </div>
        </li>
        
        <li>
            <div class="comment-thumbnail"><img src="../../../../gravatar.com/avatar/8b168bfcdb4953f8b4c2742198bc5b29ce2c.png?s=60&amp;d=identicon" /></div>
            <div class="comment-body">
                <p>
                    <span class="label label-default">#75</span> <span class="label label-primary"><a href="none.html">Nadav</a></span> said
                    <span class="flask-moment" data-timestamp="2015-02-27T13:49:42Z" data-format="fromNow(0)" data-refresh="0">2015-02-27T13:49:42Z</span>
                </p>
                <div style="overflow: auto;">
                    <p style="white-space: pre-wrap;">when I try to run ./tests.py I get the following error: -bash: ./tests.py: Permission denied

What do I do?</p>
                </div>
            </div>
        </li>
        
    </ul>
</div>

<div class="page">
<ul class="pager">
  <li class="previous">
    <a href="1.html#comments">&laquo;&laquo;</a>
  </li>
  <li class="previous">
    <a href="2.html#comments">&laquo;</a>
  </li>
  <li class="next">
    <a href="0.html#comments">&raquo;&raquo;</a>
  </li>
  <li class="next">
    <a href="4.html#comments">&raquo;</a>
  </li>
</ul>
</div>

<h3><a name="commentform"></a>Leave a Comment</h3>

<form action="#commentform" method="post"
  class="form" role="form">
  <div style="display:none;"><input id="csrf_token" name="csrf_token" type="hidden" value="1439534932.34##0e005774770394558d788d035107f51947faeb3b"></div>
  
    
    






<div class="form-group "><label class="control-label" for="name">Name</label>
        <input class="form-control" id="name" name="name" required type="text" value="">
  </div>


    




<div class="form-group "><label class="control-label" for="url">URL</label>
        <input class="form-control" id="url" name="url" type="text" value="">
  </div>


    






<div class="form-group "><label class="control-label" for="email">Email</label>
        <input class="form-control" id="email" name="email" required type="text" value="">
  </div>


    






<div class="form-group "><label class="control-label" for="comment">Comment</label>
        <textarea class="form-control" id="comment" name="comment" required></textarea>
  </div>


    




<div class="form-group "><label class="control-label" for="captcha">Captcha</label>
        
<script type="text/javascript">var RecaptchaOptions = {"custom_translations": {"audio_challenge": "Get an audio challenge", "cant_hear_this": "Download sound as MP3", "help_btn": "Help", "image_alt_text": "reCAPTCHA challenge image", "incorrect_try_again": "Incorrect. Try again.", "instructions_audio": "Type what you hear", "instructions_visual": "Type the text", "play_again": "Play sound again", "privacy_and_terms": "Privacy & Terms", "refresh_btn": "Get a new challenge", "visual_challenge": "Get a visual challenge"}, "theme": "white"};</script>
<script type="text/javascript" src="http://www.google.com/recaptcha/api/challenge?k=6Ld5Zs4SAAAAAOY0DOi4r18bgHlEaz41qAoRf__S"></script>
<noscript>
  <iframe src="http://www.google.com/recaptcha/api/noscript?k=6Ld5Zs4SAAAAAOY0DOi4r18bgHlEaz41qAoRf__S" height="300" width="500" frameborder="0"></iframe><br>
  <textarea name="recaptcha_challenge_field" rows="3" cols="40"></textarea>
  <input type="hidden" name="recaptcha_response_field" value="manual_challenge">
</noscript>

  </div>


    





  


    <input class="btn btn-default" id="submit" name="submit" type="submit" value="Submit">
  





</form>


</div>

                </div>
            </div>
        </div>
        <div id="footer">
            <p class="elapsed">This page was generated in None seconds.</p>
            <p>&copy; 2014 by Miguel Grinberg. All rights reserved. <a href="mailto:webmaster _at_ miguelgrinberg _dot_ com">Questions?</a></p>
        </div>
    </div>


    
    
    <script src="../../../../cdnjs.cloudflare.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
    <script src="../../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.0/js/bootstrap.min.js"></script>
	<script type="text/javascript" src="../../../../cdnjs.cloudflare.com/ajax/libs/jquery.colorbox/1.4.33/jquery.colorbox-min.js"></script>
    <script type="text/javascript" src="../../../static/prettify.js"></script>
    <script src="../../../../cdnjs.cloudflare.com/ajax/libs/moment.js/2.5.1/moment-with-langs.min.js"></script>
<script>
function flask_moment_render(elem) {
    $(elem).text(eval('moment("' + $(elem).data('timestamp') + '").' + $(elem).data('format') + ';'));
    $(elem).removeClass('flask-moment');
}
function flask_moment_render_all() {
    $('.flask-moment').each(function() {
        flask_moment_render(this);
        if ($(this).data('refresh')) {
            (function(elem, interval) { setInterval(function() { flask_moment_render(elem) }, interval); })(this, $(this).data('refresh'));
        }
    })
}
$(document).ready(function() {
    flask_moment_render_all();
});
</script>
    
    <script type="text/javascript">
      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-4777284-15']);
      _gaq.push(['_trackPageview']);

      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();
    </script>
    
    <script type="text/javascript">
        $(document).ready(function(){
            $(".gallery").colorbox({rel:".gallery",maxWidth:"95%",maxHeight:"95%",scalePhotos:true});
            // add prettyprint class to all <pre><code></code></pre> blocks
            var prettify = false;
            $("pre code").parent().each(function() {
                $(this).addClass('prettyprint');
                prettify = true;
            });
            prettyPrint();
        });
    </script>


  </body>

<!-- Mirrored from blog.miguelgrinberg.com/post/the-flask-mega-tutorial-part-vii-unit-testing/page/3 by HTTrack Website Copier/3.x [XR&CO'2014], Fri, 14 Aug 2015 05:51:08 GMT -->
</html>
