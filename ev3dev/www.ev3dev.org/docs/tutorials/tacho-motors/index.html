<!doctype html>
<html>
﻿
<!-- Mirrored from www.ev3dev.org/docs/tutorials/tacho-motors/ by HTTrack Website Copier/3.x [XR&CO'2014], Mon, 01 Jun 2015 09:05:34 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <title>Using the Tacho-Motor Class</title>
    <link rel="alternate" type="application/atom+xml" href="../../../news/atom.xml" title="Atom feed">
    <link rel="stylesheet" href="../../../stylesheets/styles.css">
    <link rel="stylesheet" href="../../../stylesheets/pygment_trac.css">
    <script src="../../../../ajax.googleapis.com/ajax/libs/jquery/1.9.0/jquery.min.js"></script>
    <script src="../../../javascripts/jquery.getUrlParam.js"></script>
    <script src="../../../javascripts/jquery.loadTemplate-1.4.4.min.js"></script>
    <script src="../../../javascripts/respond.js"></script>
    <script src="../../../javascripts/cards.js"></script>
    <script src="../../../javascripts/menu.js"></script>
    <script src="../../../javascripts/search.js"></script>
    <script src="../../../javascripts/tabs.js"></script>
    <script src="../../../javascripts/ua-parser.min.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <!--[if lt IE 8]>
    <link rel="stylesheet" href="stylesheets/ie.css">
    <![endif]-->
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">

    <script type="text/html" id="search-result-template">
        <div class="search-result">
            <a data-href="href"><h4 data-content="title"></h4></a>
            <span data-content="breadcrumbs" class="search-result-breadcrumbs"></span>
            <span data-content="author" class="search-result-author"></span><br/>
            <span data-content="date" class="search-result-date"></span>
        </div>
    </script>

</head>

<body>
    <div id="header" class="mobile-hidden">
    <nav>
        <li class="nav-menu">
            <img src="../../../images/menu.png" />
        </li>

        <li class="left button">
            <a href="../../../index.html" title="There's no place like Home...">Home</a>
        </li>
        <li class="left button">
            <a href="../../index.html" title="Documentation on how to use ev3dev">Docs</a>
        </li>
        <li class="left button">
            <a href="../../../news/index.html" title="News about ev3dev">News</a>
        </li>
        <li class="left button dropdown-button">
            <a>
                Community
                <div class="nav-dropdown-arrow">
                    
                </div>
            </a>
            <ul class="button-dropdown">
                <li>
                    <a href="../../../share/index.html" title="Discover and share projects that use ev3dev">Share</a>
                </li>
                <li>
                    <a href="../../../contribute/index.html" title="How to contribute to ev3dev">Contribute</a>
                </li>
                <li>
                    <a href="../../../support/index.html" title="Found a bug? Have a question?">Get Help</a>
                </li>
            </ul>
        </li>
        <li class="left button">
            <a href="https://github.com/ev3dev/ev3dev/releases" title="SD card image files">Download</a>
        </li>
        <!-- items below float right, so appear in reverse order -->
        <li class="right header-box" id="search-li">
            <input type="text" id="search-input" onfocus="searchFocus()" onkeyup="searchTextChanged()" placeholder="Quick Nav" onkeypress="this.onkeyup();" onpaste="this.onkeyup();" oninput="this.onkeyup();" />
            <div id="search-dropdown">
                <div class="search-results-container" id="search-results-docs">
                    <h2>In docs</h2>
                    <div data-content="docs-results">
                        <div class="no-results-note">No results</div>
                    </div>
                </div>

                <div class="search-results-container" id="search-results-projects">
                    <h2>In projects</h2>
                    <div data-content="project-results">
                        <div class="no-results-note">No results</div>
                    </div>
                </div>

                <div class="search-results-container" id="search-results-news">
                    <h2>In news</h2>
                    <div data-content="news-results">
                        <div class="no-results-note">No results</div>
                    </div>
                </div>

                <div class="search-results-container" id="search-results-misc">
                    <h2>In other pages</h2>
                    <div data-content="misc-results">
                        <div class="no-results-note">No results</div>
                    </div>
                </div>
            </div>
        </li>
    </nav>
</div>

<!-- make sure this get included on every page -->
<!--[if !IE]><script>fixScale(document);</script><![endif]-->

    <div class="wrapper">
        <section>
            <div id="title">
    <div id="logoContainer">
        <a href="../../../index.html">
            <img id="logo" src="../../../../avatars3.githubusercontent.com/u/6878323782c.png?s=140" />
        </a>
        <div id="titleHeader" class="clear">
            <h1 id="pageTitle">Using the Tacho-Motor Class</h1>
            <p id="pageSubtitle"></p>
        </div>
    </div>
    <hr class="clear">
</div>


            <div id="mainContent">
                
    

<div class="edit-on-github">
<a href="https://github.com/ev3dev/ev3dev.github.io/edit/master/docs/tutorials/tacho-motors.md">Edit on Github</a>
</div>
<div class="breadcrumbs">
﻿


    
        
        <a href="../../index.html">docs</a> &gt;
    

    
        
        <a href="../index.html">tutorials</a> &gt;
    

    
        tacho-motors
    


</div>
<hr />

<ul id="markdown-toc">
  <li><a href="#about-tachometers">About tachometers</a></li>
  <li><a href="#identifying-the-motor">Identifying the Motor</a></li>
  <li><a href="#reseting-the-motor">Reseting the Motor</a></li>
  <li><a href="#position-and-speed">Position and Speed</a></li>
  <li><a href="#running-the-motor">Running the Motor</a>    <ul>
      <li><a href="#run-forever">run-forever</a></li>
      <li><a href="#run-to-abs-pos">run-to-abs-pos</a></li>
      <li><a href="#run-to-rel-pos">run-to-rel-pos</a></li>
      <li><a href="#run-timed">run-timed</a></li>
      <li><a href="#run-direct">run-direct</a></li>
    </ul>
  </li>
  <li><a href="#stopping-the-motor">Stopping the Motor</a>    <ul>
      <li><a href="#coast">coast</a></li>
      <li><a href="#brake">brake</a></li>
      <li><a href="#hold">hold</a></li>
    </ul>
  </li>
  <li><a href="#polarity">Polarity</a></li>
  <li><a href="#speed-regulation">Speed Regulation</a></li>
  <li><a href="#ramping">Ramping</a></li>
  <li><a href="#state-flags">State Flags</a>    <ul>
      <li><a href="#running">running</a></li>
      <li><a href="#ramping-1">ramping</a></li>
      <li><a href="#holding">holding</a></li>
      <li><a href="#stalled">stalled</a></li>
    </ul>
  </li>
</ul>

<p>This tutorial uses a command line shell to demonstrate how to use the <a href="../../drivers/tacho-motor-class/index.html">tacho-motor</a> class.</p>

<h2 id="about-tachometers">About tachometers</h2>

<p>A <a href="https://en.wikipedia.org/wiki/Tachometer">tachometer</a> is a device that measures rotational speed. The LEGO MINDSTORMS
NXT and EV3 motors have an optical encoder that sends electrical pulses to the
EV3 when the motor rotates.</p>

<p>We call any motor that can see feedback like this a “tacho-motor”. Using this
feedback, you have greater control over the speed and position of the motor
compared to motors that do not provide feedback.</p>

<h2 id="identifying-the-motor">Identifying the Motor</h2>

<p>Always be sure to check the <code>port_name</code> attribute to identify a motor (same with
sensors). Here is a command that lists the <code>port_name</code> of all tacho motors…</p>

<pre><code>$ for f in /sys/class/tacho-motor/*; do echo -n "$f: "; cat $f/port_name; done
/sys/class/tacho-motor/motor0: outA
/sys/class/tacho-motor/motor1: outB
/sys/class/tacho-motor/motor2: outC
/sys/class/tacho-motor/motor3: outD
/sys/class/tacho-motor/motor4: in4:i2c3:mux0
/sys/class/tacho-motor/motor5: in4:i2c3:mux1
</code></pre>

<p>I have a motor plugged into each of the four output ports of the EV3 (A-D) and
I also have a mindsensors.com NxtMMX plugged into input port 4 which provides
two additional motors. So, for example, if I want to control the motor attached
to output port C, then I need to use the path <code>/sys/class/tacho-motor/motor2</code>.</p>

<p>To save some typing, I’m going to define a variable for the motor path…</p>

<pre><code>$ export MC=/sys/class/tacho-motor/motor2
</code></pre>

<p>Now we can just type <code>$MC</code> for the motor path.</p>

<h2 id="reseting-the-motor">Reseting the Motor</h2>

<p>The tacho-motor class has a <code>reset</code> command that resets all of the parameters
back to the default values and stops the motor. It is a good idea to send this
command at the start of a program to ensure the motor is in a known state without
having to write each of the parameters individually. Let’s do that first…</p>

<pre><code>$ echo reset &gt; $MC/command
</code></pre>

<h2 id="position-and-speed">Position and Speed</h2>

<p>Unlike other MINDSTORMS software, the units of measurement used are in tachometer
counts rather than rotations or degrees. This can be tricky because for the NXT
and EV3 motors, one pulse of the tachometer = one degree. If you use a 3rd party
motor, it may be different.</p>

<p>Let’s start by looking at the <code>position</code> attribute…</p>

<pre><code>$ cat $MC/position
0
</code></pre>

<p>If you have not rotated your motor since you plugged it in, it should say <code>0</code>.
If not, we can reset it with…</p>

<pre><code>$ echo 0 &gt; $MC/position
</code></pre>

<p>Note: you will get an error if you do this while the motor is running.</p>

<p>Now, turn the motor one rotation by hand and read the position again…</p>

<pre><code>$ cat $MC/position
345
</code></pre>

<p>It should be somewhere close to the value returned by the <code>count_per_rot</code>
(tachometer pulse counts per one rotation) attribute…</p>

<pre><code>$ cat $MC/count_per_rot
360
</code></pre>

<p>Speed is similar in that the units are in tachometer pulse counts per second.
You can watch the speed by running…</p>

<pre><code>$ while true; do echo -en "\033[0G$(cat $MC/speed)   "; done
</code></pre>

<p>… and then turn the motor by hand to watch the value change. You should see
numbers between +/-300 (unless you are not being nice to your motor and turning
it very fast). Press <code>^C</code> when you are done. Note: <code>\033[0G</code> is an escape code
that moves the cursor back to the beginning of the line so that we don’t fill up
the screen with numbers.</p>

<h2 id="running-the-motor">Running the Motor</h2>

<p>The most obvious thing to do with a motor is make it run, so let’s do that first.</p>

<p>To run the motor, we need to send
it a command. To find out what commands are available, read the <code>commands</code> attribute.
Other motor controllers, such as the NxtMMX may not support all of the possible
commands, so it is always good to check this attribute.</p>

<pre><code>$ cat $MC/commands
run-forever run-to-abs-pos run-to-rel-pos run-timed run-direct stop reset
</code></pre>

<p>Let’s have a look at the <code>run-*</code> commands.</p>

<h3 id="run-forever">run-forever</h3>

<p>This command works like “Duration: unlimited” in NXT-G or “On” in EV3-G. The
motor will run until we send another command. So, let’s run it…</p>

<pre><code>$ echo run-forever &gt; $MC/command
</code></pre>

<p>… and nothing happens. We forgot to tell it how fast to go. We do this by
setting the <code>duty_cycle_sp</code> to a value between 0 and 100…</p>

<pre><code>$ echo 50 &gt; $MC/duty_cycle_sp
</code></pre>

<p>… and still nothing happens. This is because parameters only take effect when
we send a command. If we change a parameter, we have to send the command again
in order to apply the changes.</p>

<pre><code>$ echo run-forever &gt; $MC/command
</code></pre>

<p>… now the motor is running. Let’s make the motor turn in the opposite
direction, but a little slower. Using a negative value changes the direction…</p>

<pre><code>$ echo -20 &gt; $MC/duty_cycle_sp
$ echo run-forever &gt; $MC/command
</code></pre>

<p>… and stop it…</p>

<pre><code>$ echo stop &gt; $MC/command
</code></pre>

<h3 id="run-to-abs-pos">run-to-abs-pos</h3>

<p>This means “run to absolute position”. The position is specified by writing to
the <code>position_sp</code> attribute. Remember, the units are in tachometer pulse counts,
so if you are not using a LEGO motor, then you will need to do some math to
convert to/from degrees.</p>

<p>The <code>position_sp</code> should be at 0, so if we send this command, the motor will
run until the <code>position</code> is 0. If you have turned the motor many times, this
could take a while. We’ll add an extra command so we can watch the position
change.</p>

<pre><code>$ cat $MC/position_sp
0
$ echo run-to-abs-pos &gt; $MC/command
$ while true; do echo -en "\033[0G$(cat $MC/position)   "; done
</code></pre>

<h3 id="run-to-rel-pos">run-to-rel-pos</h3>

<p>This means “run to relative position”. Again, the position is specified by
<code>position_sp</code>, but this time the value is added to the current position. So,
if we run…</p>

<pre><code>$ echo 180 &gt; $MC/position_sp
$ echo run-to-rel-pos &gt; $MC/command
</code></pre>

<p>… the motor will turn 1/2 of a turn. If we run…</p>

<pre><code>$ echo run-to-rel-pos &gt; $MC/command
</code></pre>

<p>… again, the motor will turn an additional 1/2 turn.</p>

<p>Note: Using a negative value for <code>position_sp</code> will cause the motor to rotate
in the opposite direction.</p>

<h3 id="run-timed">run-timed</h3>

<p>This is an easy way to run the motor for a specified time asynchronously.
Essentially, it starts the motor using the <code>run-forever</code> command and sets a
timer in the kernel to run the <code>stop</code> command after the specified time. The
time, in milliseconds, is written to the <code>time_sp</code> attribute.</p>

<pre><code>$ echo 2000 &gt; $MC/time_sp
$ echo run-timed &gt; $MC/command
</code></pre>

<p>This will cause the motor to run for 2 seconds. Notice that writing to <code>command</code>
returns immediately. If you need to block the program from running while the
motor runs for a period of time, you should use the <code>run-forever</code> and <code>stop</code>
command along with the built-in time delay functions in your programming
language.</p>

<pre><code>$ run-for-time() { echo run-forever &gt; $MC/command; sleep $1; echo stop &gt; $MC/command; }
$ run-for-time 2
</code></pre>

<p>This function does not return until the time has elapsed (it runs synchronously).</p>

<p>Likewise, if you need your program to <em>not</em> block during the time delay, but you
need something to happen after the time delay, you should use the features of
your programming language for an asynchronous callback, like <code>setTimeout()</code> in
javascript.</p>

<pre><code>$ run-for-time() { echo run-forever &gt; $MC/command; (sleep $1; echo stop &gt; $MC/command;) &amp; }
$ run-for-time 2
</code></pre>

<h3 id="run-direct">run-direct</h3>

<p>This command works just like <code>run-forever</code> except that changes to <code>duty_cycle_sp</code>
take effect immediately instead of having to send a new command. This is useful
for implementing your own PID or something similar that needs to update the
motor output very quickly.</p>

<p>Note: Not all motor controller support this command.</p>

<p>So, like before, we can start the motor…</p>

<pre><code>$ echo 20 &gt; $MC/duty_cycle_sp
$ echo run-direct &gt; $MC/command
</code></pre>

<p>But, this time when we change the duty cycle, the motor speed changes…</p>

<pre><code>$ echo 30 &gt; $MC/duty_cycle_sp
</code></pre>

<h2 id="stopping-the-motor">Stopping the Motor</h2>

<p>As we have already seen, with the <code>run-to-*-pos</code> and <code>run-timed</code> commands, the
motor will stop automatically. For the other run commands, you have to send a
<code>stop</code> command to make the motor stop. The motor actually has three possible
behaviors when it stops. We can list them by reading the <code>stop_commands</code> attribute…</p>

<pre><code>$ cat $MC/stop_commands
coast brake hold
</code></pre>

<p>Note: Some motor controllers may not support all of these, so it is a good idea
to always check this attribute.</p>

<h3 id="coast">coast</h3>

<p><code>coast</code> means that power will be removed from the motor and it will coast to a
stop. Let’s try it…</p>

<pre><code>$ echo 100 &gt; $MC/duty_cycle_sp
$ echo 1000 &gt; $MC/time_sp
$ echo coast &gt; $MC/stop_command
$ echo run-timed &gt; $MC/command
</code></pre>

<p>Notice how it takes the motor about 1 additional second to actually stop. Also,
try turning the motor by hand. It turns fairly easily.</p>

<h3 id="brake">brake</h3>

<p><code>brake</code> means to use passive braking, which is another way of saying that the
motor controller removes power from the motor, but it also shorts the power
wires of the motor together. When a motor is manually rotated, it acts as an
electrical generator, so shorting the power wires creates a load that absorbs
the energy.</p>

<pre><code>$ echo brake &gt; $MC/stop_command
$ echo run-timed &gt; $MC/command
</code></pre>

<p>Notice how much faster the motor stops this time. Also try turning it by hand.
The motor turns, but it is more difficult to turn.</p>

<h3 id="hold">hold</h3>

<p><code>hold</code> means to actively hold the motor position when stopping. Instead of
removing power from the motor, the motor controller will start a PID to prevent
the motor from being turned any farther. This stop command is really intended
for use with the <code>run-to-*-pos</code> commands. It will work with other run commands,
but may result in unexpected behavior.</p>

<pre><code>$ echo hold &gt; $MC/stop_command
$ echo 180 &gt; $MC/position_sp
$ echo run-to-rel-pos &gt; $MC/command
</code></pre>

<p>Try to turn the motor now. The motor might turn a small amount, but the more you
push, the more it will push back. You can actually see how hard the motor is
pushing back by reading the <code>duty_cycle</code> attribute. This attribute returns the
actual power being sent to the motor (0 to +/-100%)…</p>

<pre><code>$ while true; do echo -en "\033[0G$(cat $MC/duty_cycle)   "; done
</code></pre>

<h2 id="polarity">Polarity</h2>

<p>The “forward” direction of a motor can be changed using the <code>polarity</code> attribute.
This is useful, for example, when you have two motors used as drive wheels. By
changing the polarity of one of the two motors, you can send a positive value
to both motor to drive forwards.</p>

<p>Normally, the polarity is <code>normal</code>…</p>

<pre><code>$ cat $MC/polarity
normal
</code></pre>

<p>Run the motor and see which way it rotates…</p>

<pre><code>$ echo 30 &gt; $MC/duty_cycle_sp
$ echo run-forever &gt; $MC/command
$ while true; do echo -en "\033[0G$(cat $MC/position) $(cat $MC/speed)   "; done
</code></pre>

<p>The position is increasing and the speed is positive. Then change the polarity
to <code>inversed</code>…</p>

<pre><code>$ echo inversed &gt; $MC/polarity
</code></pre>

<p>Like before, nothing happens. We have to send a command again…</p>

<pre><code>$ echo run-forever &gt; $MC/command
$ while true; do echo -en "\033[0G$(cat $MC/position) $(cat $MC/speed)   "; done
</code></pre>

<p>Now, the motor runs in the opposite direction, however the position is still
increasing and the speed is still positive. Be sure to change to polarity back
to <code>normal</code> before continuing…</p>

<pre><code>$ echo stop &gt; $MC/command
$ echo normal &gt; $MC/polarity
</code></pre>

<h2 id="speed-regulation">Speed Regulation</h2>

<p>So far, we have just specified a duty cycle to control the speed of the motor.
This is OK, but the actual speed of the motor will depend on battery voltage
and the load on the motor. If you have an application where you need repeatable
results, it might be better to run the motor at a fixed speed. You can do this
by turning on speed regulation…</p>

<pre><code>$ echo on &gt; $MC/speed_regulation
</code></pre>

<p>Now, instead of using the <code>duty_cycle_sp</code>, the driver will use <code>speed_sp</code>. As
discussed already, the units are tachometer counts per second. You can convert
to RPM by dividing the value in <code>count_per_rot</code>. For the EV3 large motor, the
maximum speed is about 900 counts per second and the EV3 medium motor is about
1200 counts per second. To ensure that the motor runs at the same speed every
time, event with low battery, use values less than these.</p>

<p>First, let’s see what happens when speed regulation is off…</p>

<pre><code>$ echo off &gt; $MC/speed_regulation
$ echo 30 &gt; $MC/duty_cycle_sp
$ echo run-forever &gt; $MC/command
$ while true; do echo -en "\033[0G$(cat $MC/duty_cycle) $(cat $MC/speed)   "; done
</code></pre>

<p>The motor runs somewhere around 275 counts per second. Use your fingers to slow
down the motor. Notice that the duty cycle remains constant and the speed
decreases when you place a load on the motor. Now, let’s try speed regulation…</p>

<pre><code>$ echo stop &gt; $MC/command
$ echo on &gt; $MC/speed_regulation
$ echo 275 &gt; $MC/speed_sp
$ echo run-forever &gt; $MC/command
$ while true; do echo -en "\033[0G$(cat $MC/duty_cycle) $(cat $MC/speed)   "; done
</code></pre>

<p>With no load, the duty cycle should be about the same as before (30%). Now, use
your fingers to slow down the motor again. This time, the driver increases the
duty cycle to make up for the load on the motor. As long as the load on the
motor remains constant, the speed should remain fairly constant. It may
overcompensate a bit though if the load changes rapidly.</p>

<p>Speed regulation works with all of the run commands. Just remember, you need to
set <code>speed_sp</code> instead of <code>duty_cycle_sp</code> when speed regulation is on.</p>

<h2 id="ramping">Ramping</h2>

<p>Ramping needs some work in the drivers, so nothing here yet…</p>

<h2 id="state-flags">State Flags</h2>

<p>You can monitor several aspects of the motor by reading the <code>state</code> attribute.
Possible values are <code>running</code>, <code>ramping</code>, <code>holding</code> and <code>stalled</code>. Reading the
attribute returns a space-separated list of flags, so use your programming
language’s string split function to split on the space (ascii 32) character to
get individual flags or use the string contains (or index of) function to test
for the presence of a flag.</p>

<h3 id="running">running</h3>

<p>This flag indicates that the motor is powered. This means that a run command is
active or if the stop command is <code>hold</code>, the motor is holding position. If the
power is low enough, the motor may not actually be moving even though the
<code>running</code> flag is present.</p>

<p>Note: To check that a run command is active when stop mode is <code>hold</code>, checking
the <code>running</code> flag is not enough. e.g. run-command-active = <code>running</code> and not
<code>holding</code>.</p>

<h3 id="ramping-1">ramping</h3>

<p>This flag indicates that the motor is ramping up or down rather than operating
at the duty cycle or speed setpoint.</p>

<h3 id="holding">holding</h3>

<p>This flag indicates that no run command is active but the motor is still being
powered to hold the position because the stop command is set to <code>hold</code>.</p>

<h3 id="stalled">stalled</h3>

<p>This flag indicates that a run command is trying to rotate the motor, but the
motor is not actually moving. This can be caused by something mechanically
preventing the motor from rotating or it could mean that the power being sent
to the motor is not enough (too small) to make the motor move.</p>


            </div>
        </section>
        <div id="footer">
    <hr class="clear">
    <div class="cclicense">

        <span xmlns:dct="http://purl.org/dc/terms/" property="dct:title">
            www.ev3dev.org (with the exception of the projects pages)
        </span>
        is licensed under
        <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">
            <img alt="Creative Commons License" style="border-width:0" src="../../../../licensebuttons.net/l/by-sa/4.0/80x15.png" />
        </a>.
        <br />
        You are free to copy the text and images, but please be courteous and acknowledge the source.

    </div>
    <br />
    <hr class="clear">
    <span class="credits left">
        Project maintained by <a href="https://github.com/rhempel">Ralph Hempel</a>
        and <a href="https://github.com/dlech">David Lechner</a>, with help from the community
    </span>
    <span class="credits right">
        Hosted on GitHub Pages <!--&mdash; Theme by <a href="https://twitter.com/michigangraham">mattgraham</a>-->
    </span>
</div>

    </div>
</body>

<!-- Mirrored from www.ev3dev.org/docs/tutorials/tacho-motors/ by HTTrack Website Copier/3.x [XR&CO'2014], Mon, 01 Jun 2015 09:05:34 GMT -->
</html>
